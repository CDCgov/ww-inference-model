---
title: "Title"
description: "des"
author: "Christian O. Bernal Zelaya"
date: "2024-09-03"
output:
  bookdown::html_vignette2:
    fig_caption: yes
    code_folding: show
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r echo=FALSE}
knitr::opts_chunk$set(dev = "svg")
```

# Start

Here we present the way simulating and fitting with 3 separate models using the
`wwinference` package.  We also compare the results a number of ways to see
the value of using spatial components within the model.
```{r}
library(wwinference)
library(dplyr)
library(tibble)
library(tidyr)
library(ggplot2)
library(patchwork)
library(ggridges)
library(scico)
library(scoringutils)
library(ggh4x)
```


# Generating Data

We start by generating the data that our models require, using the
`generate_simulation_data` function.  The presets that are required to use the
spatial components are `use_spatial_corr = TRUE` and `aux_site_bool = TRUE`.
We also require that if `use_spatial_corr = TRUE`, the user must specify a
correlation function in the `corr_function` and the necessary parameters of the
function in `corr_fun_params`.  Currently we have 3 built in functions for
correlation types : `independence_corr_func_r`, `exponential_decay_corr_func_r`,
and `rand_corr_matrix_func`.  The default used is `exponential_decay_corr_func_r`
correlation function based of the following fake locations.

## Fake locations
```{r}
set.seed(2024)
n_sites <- 6
fake_locs <- data.frame(
  # // x = c(85, 37, 36, 7),
  # // y = c(12, 75, 75, 96),
  x = runif(n_sites, 0, 100),
  y = runif(n_sites, 0, 100),
  ID = paste0("Site ", 1:n_sites)
) %>%
  mutate(
    for_text_x = 0,
    for_text_y = 0
  )
fake_locs_plot <- ggplot(
  data = fake_locs
) +
  geom_point(
    aes(x = x, y = y),
    color = "blue",
    size = 3
  ) +
  geom_text(
    aes(label = ID, x = x + for_text_x, y = y + for_text_y),
    vjust = -0.6
  ) +
  geom_segment(
    aes(x = x, y = y, xend = x + for_text_x, yend = y + for_text_y),
    color = "black"
  ) +
  labs(
    title = "Fake Locations",
    x = "X Coordinate",
    y = "Y Coordinate"
  ) +
  theme_bw()

fake_locs_plot
```

## Central Rt Curve
```{r}
r_in_weeks <- c(
  rep(1.1, 5), rep(0.9, 5),
  0.9 + 0.0005 * (1:16)^2
)
# // r_in_weeks <- c(
# //   rep(1.1, 5), rep(0.9, 5),
# //   1 + 0.007 * 1:16
# // )
lng <- length(r_in_weeks)
central_rt_curve <- ggplot() +
  geom_line(
    aes(
      x = 1:lng,
      y = r_in_weeks
    )
  ) +
  geom_point(
    aes(
      x = 1:lng,
      y = r_in_weeks
    )
  ) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    linetype = "dashed",
    alpha = .7
  ) +
  scale_y_continuous(transform = "log10") +
  xlab("Week") +
  ylab("Rt Value") +
  ggtitle("Central Rt curve") +
  theme_bw()

central_rt_curve
```

## Simulating data
```{r warning=FALSE, message=FALSE}
# Presets ----------------------------------------------------------------------
set.seed(1)
site <- 1:n_sites
lab <- rep(1, n_sites)
ww_pop_sites <- c(5e5, 7.5e5, 3.8e5, 4.5e5, 5.5e5, 3.7e5) # , 6e5, 4e5)
pop_size <- 5e6
global_rt_sd <- 0
exp_corr_param <- list(
  dist_matrix = as.matrix(
    dist(
      data.frame(
        x = fake_locs$x,
        y = fake_locs$y
      ),
      diag = TRUE,
      upper = TRUE
    )
  ),
  phi = 0.2,
  # // phi = 0.4
  l = 1
)
sigma_generalized <- 0.01^n_sites
# ------------------------------------------------------------------------------
# IID Simulated Data -----------------------------------------------------------
simulated_data_iid <- withr::with_seed(1, {
  wwinference::generate_simulated_data(
    r_in_weeks = r_in_weeks, # nolint
    n_sites = n_sites,
    site = site,
    lab = lab,
    ww_pop_sites = ww_pop_sites,
    pop_size = pop_size,
    global_rt_sd = global_rt_sd,
    use_spatial_corr = TRUE,
    corr_function = wwinference::independence_corr_func_r,
    corr_fun_params = list(num_sites = n_sites),
    sigma_generalized = sigma_generalized,
    aux_site_bool = TRUE
  )
})
# ------------------------------------------------------------------------------
# Exponential Simulated Data ---------------------------------------------------
simulated_data_exp <- withr::with_seed(1, {
  wwinference::generate_simulated_data(
    r_in_weeks = r_in_weeks, # nolint
    n_sites = n_sites,
    site = site,
    lab = lab,
    ww_pop_sites = ww_pop_sites,
    pop_size = pop_size,
    global_rt_sd = global_rt_sd,
    use_spatial_corr = TRUE,
    corr_function = exponential_decay_corr_func_r,
    corr_fun_params = exp_corr_param,
    sigma_generalized = sigma_generalized,
    aux_site_bool = TRUE
  )
})
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix Simulated Data --------------------------------------------
simulated_data_rng_corr_mat <- withr::with_seed(1, {
  wwinference::generate_simulated_data(
    r_in_weeks = r_in_weeks, # nolint
    n_sites = n_sites,
    site = site,
    lab = lab,
    ww_pop_sites = ww_pop_sites,
    pop_size = pop_size,
    global_rt_sd = global_rt_sd,
    use_spatial_corr = TRUE,
    corr_function = wwinference::rand_corr_matrix_func,
    corr_fun_params = list(n_sites = n_sites, seed = 2024),
    sigma_generalized = sigma_generalized,
    aux_site_bool = TRUE
  )
})
# ------------------------------------------------------------------------------
```

## Preparing data
```{r}
# iid case
hosp_data_preprocessed_iid <- wwinference::preprocess_count_data(
  simulated_data_iid$hosp_data,
  count_col_name = "daily_hosp_admits",
  pop_size_col_name = "state_pop"
)
ww_data_preprocessed_iid <- wwinference::preprocess_ww_data(
  simulated_data_iid$ww_data
)
ww_data_to_fit_iid <- wwinference::indicate_ww_exclusions(
  ww_data_preprocessed_iid,
  outlier_col_name = "flag_as_ww_outlier",
  remove_outliers = TRUE
)

# exponential case
hosp_data_preprocessed_exp <- wwinference::preprocess_count_data(
  simulated_data_exp$hosp_data,
  count_col_name = "daily_hosp_admits",
  pop_size_col_name = "state_pop"
)
ww_data_preprocessed_exp <- wwinference::preprocess_ww_data(
  simulated_data_exp$ww_data
)
ww_data_to_fit_exp <- wwinference::indicate_ww_exclusions(
  ww_data_preprocessed_exp,
  outlier_col_name = "flag_as_ww_outlier",
  remove_outliers = TRUE
)

# rand corr mat case
hosp_data_proc_rng_corr_mat <- wwinference::preprocess_count_data(
  simulated_data_rng_corr_mat$hosp_data,
  count_col_name = "daily_hosp_admits",
  pop_size_col_name = "state_pop"
)
ww_data_proc_rng_corr_mat <- wwinference::preprocess_ww_data(
  simulated_data_rng_corr_mat$ww_data
)
ww_data_to_fit_rng_corr_mat <- wwinference::indicate_ww_exclusions(
  ww_data_proc_rng_corr_mat,
  outlier_col_name = "flag_as_ww_outlier",
  remove_outliers = TRUE
)
```

## Visualziing
We can explore what this generated data looks like given the different types of
correlation functions given into the `generate_simulated_data` function.

### Visualizing data
```{r}
# hosp plots--------------------------------------------------------------------
hosp_data_full <- rbind(
  hosp_data_preprocessed_iid %>%
    mutate(model_type = "IID"),
  hosp_data_preprocessed_exp %>%
    mutate(model_type = "Exponential"),
  hosp_data_proc_rng_corr_mat %>%
    mutate(model_type = "Rand. Corr. Matrix")
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
hosp_data_eval_full <- rbind(
  simulated_data_iid$hosp_data_eval %>%
    mutate(model_type = "IID"),
  simulated_data_exp$hosp_data_eval %>%
    mutate(model_type = "Exponential"),
  simulated_data_rng_corr_mat$hosp_data_eval %>%
    mutate(model_type = "Rand. Corr. Matrix")
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
hosp_data_plot <- ggplot(hosp_data_full) +
  geom_point(
    data = hosp_data_eval_full, aes(
      x = date,
      y = daily_hosp_admits_for_eval
    ),
    shape = 21, color = "black", fill = "white"
  ) +
  # Plot the data we will calibrate to
  geom_point(aes(x = date, y = count)) +
  xlab("") +
  ylab("Daily hospital admissions") +
  facet_wrap(~model_type, scales = "free_y") +
  theme_bw()
# ------------------------------------------------------------------------------

# ww plots----------------------------------------------------------------------
ww_data_full <- rbind(
  ww_data_preprocessed_iid %>%
    mutate(model_type = "IID"),
  ww_data_preprocessed_exp %>%
    mutate(model_type = "Exponential"),
  ww_data_proc_rng_corr_mat %>%
    mutate(model_type = "Rand. Corr. Matrix")
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
ww_data_plot <- ggplot(ww_data_full) +
  geom_point(
    aes(
      x = date, y = log_genome_copies_per_ml
    ),
    show.legend = FALSE
  ) +
  geom_hline(aes(yintercept = log_lod), linetype = "dashed") +
  facet_grid(site ~ model_type,
    scales = "fixed",
    labeller = labeller(site = function(x) paste("Site", x))
  ) +
  xlab("") +
  ylab("Genome copies/mL on Log Scale") +
  theme_bw()
# ------------------------------------------------------------------------------

hosp_data_plot / ww_data_plot +
  plot_layout(heights = c(1, 2))
```


```{r}
ww_total_plot <- ggplot(ww_data_full) +
  geom_line(
    aes(
      x = date, y = log_genome_copies_per_ml,
      colour = factor(site)
    )
  ) +
  geom_point(
    aes(
      x = date, y = log_genome_copies_per_ml,
      colour = factor(site)
    )
  ) +
  geom_hline(
    aes(yintercept = log_lod, colour = factor(site)),
    linetype = "dashed"
  ) +
  facet_grid(
    ~model_type,
    scales = "fixed"
  ) +
  scale_color_manual(
    breaks = c("1", "2", "3", "4", "5", "6"),
    values = c(
      "darkviolet", "darkblue", "darkgreen",
      "darkred", "gold", "darkorange"
    )
  ) +
  xlab("") +
  ylab("Genome copies/mL on log scale") +
  labs(color = "Site") +
  theme_bw()
ww_total_plot
```


### Visualizing actual Rt curves
```{r}
# Global Rt --------------------------------------------------------------------
rt_global_data_full <- rbind(
  simulated_data_iid$rt_global_data %>%
    as.data.frame() %>%
    `colnames<-`(c("global_rt")) %>%
    mutate(
      model_type = "IID",
      date = simulated_data_iid$hosp_data_eval$date
    ),
  simulated_data_exp$rt_global_data %>%
    as.data.frame() %>%
    `colnames<-`(c("global_rt")) %>%
    mutate(
      model_type = "Exponential",
      date = simulated_data_exp$hosp_data_eval$date
    ),
  simulated_data_rng_corr_mat$rt_global_data %>%
    as.data.frame() %>%
    `colnames<-`(c("global_rt")) %>%
    mutate(
      model_type = "Rand. Corr. Matrix",
      date = simulated_data_rng_corr_mat$hosp_data_eval$date
    )
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
global_rt_data_plot <- ggplot(rt_global_data_full) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    linetype = "dashed",
    alpha = .7
  ) +
  geom_line(aes(
    x = date,
    y = (global_rt),
  )) +
  scale_y_continuous(transform = "log10") +
  xlab("") +
  ylab("Global R(t)") +
  facet_grid(~model_type) +
  theme_bw()
# ------------------------------------------------------------------------------

# Site Rt ----------------------------------------------------------------------
site_rt_data_full <- rbind(
  simulated_data_iid$rt_site_data %>%
    t() %>%
    as.data.frame() %>%
    mutate(date = simulated_data_iid$hosp_data_eval$date) %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites),
      "Aux",
      "date"
    )) %>%
    pivot_longer(cols = -date) %>%
    `colnames<-`(c(
      "date",
      "subpop",
      "value"
    )) %>%
    mutate(
      model_type = "IID"
    ),
  simulated_data_exp$rt_site_data %>%
    t() %>%
    as.data.frame() %>%
    mutate(date = simulated_data_exp$hosp_data_eval$date) %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites),
      "Aux",
      "date"
    )) %>%
    pivot_longer(cols = -date) %>%
    `colnames<-`(c(
      "date",
      "subpop",
      "value"
    )) %>%
    mutate(
      model_type = "Exponential"
    ),
  simulated_data_rng_corr_mat$rt_site_data %>%
    t() %>%
    as.data.frame() %>%
    mutate(date = simulated_data_rng_corr_mat$hosp_data_eval$date) %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites),
      "Aux",
      "date"
    )) %>%
    pivot_longer(cols = -date) %>%
    `colnames<-`(c(
      "date",
      "subpop",
      "value"
    )) %>%
    mutate(
      model_type = "Rand. Corr. Matrix"
    )
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
site_rt_data_plot <- ggplot(site_rt_data_full) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    linetype = "dashed",
    alpha = .7
  ) +
  geom_line(aes(
    x = date,
    y = (value)
  )) +
  facet_grid(subpop ~ model_type) +
  scale_y_continuous(transform = "log10") +
  xlab("") +
  ylab("Subpopulation R(t)") +
  theme_bw()

# ------------------------------------------------------------------------------

global_rt_data_plot / site_rt_data_plot +
  plot_layout(heights = c(1, n_sites))
```

```{r}
site_rt_total_plot <- ggplot(site_rt_data_full) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    linetype = "dashed",
    alpha = .7
  ) +
  geom_line(aes(
    x = date, y = value,
    colour = factor(subpop)
  )) +
  facet_grid(~model_type,
    scales = "fixed"
  ) +
  scale_color_manual(
    breaks = c(
      "Site 1", "Site 2", "Site 3", "Site 4",
      "Site 5", "Site 6", "Aux"
    ),
    values = c(
      "darkviolet", "darkblue", "darkgreen",
      "darkred", "gold", "darkorange", "grey"
    )
  ) +
  scale_y_continuous(transform = "log10") +
  xlab("") +
  ylab("Subpopulation R(t)") +
  labs(color = "Sites") +
  theme_bw()

site_rt_total_plot
```


### Visual of correlation matrix
```{r}
# Correlation Visuals ----------------------------------------------------------
corr_matrix_df <- rbind(
  simulated_data_iid$corr_matrix %>%
    as.data.frame() %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    `rownames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    rownames_to_column(var = "Var1") %>%
    pivot_longer(
      -Var1,
      names_to = "Var2",
      values_to = "value"
    ) %>%
    mutate(
      model_type = "IID"
    ),
  simulated_data_exp$corr_matrix %>%
    as.data.frame() %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    `rownames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    rownames_to_column(var = "Var1") %>%
    pivot_longer(
      -Var1,
      names_to = "Var2",
      values_to = "value"
    ) %>%
    mutate(
      model_type = "Exponential"
    ),
  simulated_data_rng_corr_mat$corr_matrix %>%
    as.data.frame() %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    `rownames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    rownames_to_column(var = "Var1") %>%
    pivot_longer(
      -Var1,
      names_to = "Var2",
      values_to = "value"
    ) %>%
    mutate(
      model_type = "Rand. Corr. Matrix"
    )
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  ) %>%
  mutate(
    Var2 = factor(
      Var2,
      levels = paste0("Site ", n_sites:1)
    )
  )
corr_matrix_plot <- ggplot(corr_matrix_df, aes(Var1, Var2)) +
  geom_point(
    aes(size = abs(value), fill = value),
    shape = 21,
    color = "black"
  ) +
  # // scale_fill_gradient2(
  # //  low = "blue",
  # //  high = "red",
  # //  mid = "white",
  # //  midpoint = 0,
  # //  limit = c(-1, 1),
  # //  space = "Lab",
  # //  name = "Correlation"
  # // ) +
  scale_fill_scico(
    palette = "vik",
    direction = 1,
    limits = c(-1, 1),
    name = "Correlation"
  ) +
  scale_size(
    range = c(1, 10),
    guide = "none"
  ) +
  scale_x_discrete(position = "top") +
  coord_fixed() +
  ylab("") +
  xlab("") +
  facet_grid(~model_type, switch = "x") +
  ggtitle("Correlation Matrix Visuals") +
  theme_bw()
# ------------------------------------------------------------------------------

corr_matrix_plot
```


# Fitting Data
We now show how we can fit different types of models to the data.  We currently
only have 3 spatial structures to choose from when using the `wwinference` model.
Those are iid, for non-spatial assumptions where we infer only a common
generalized variance, exponential correlation function based off distances of
subpopulations or sites where we infer the parameters of the correlation
function, and unstructured where the entire correlation matrix is infered.  The
switch required to change from each type is `corr_structure_switch` in the
`wwinference` function.  Inputs for this switch are currently, `0` - iid,
`1` - exponential, and `2` - unstructured.  Keep in mind that if exponential is
used, a distance matrix is required as input as well.

Here we will fit each data, iid, exponential, rand. corr. matrix to the 3 types
of inference models, iid, exponential, and unstructured.

## Fitting presets
```{r warning=FALSE, message=FALSE}
params <- get_params(
  system.file("extdata", "example_params.toml",
    package = "wwinference"
  )
)
forecast_date <- "2023-12-06"
calibration_time <- 90
forecast_horizon <- 28

generation_interval <- wwinference::default_covid_gi
inf_to_hosp <- wwinference::default_covid_inf_to_hosp

# Assign infection feedback equal to the generation interval
infection_feedback_pmf <- generation_interval

model <- wwinference::compile_model()

iter_warmup <- 150
iter_sampling <- 500
```

## Fitting iid data
```{r warning=FALSE, message=FALSE}
# // iter_warmup <- 25
# // iter_sampling <- 50
# IID data to IID model --------------------------------------------------------
fit_iid_to_iid <- wwinference::wwinference(
  ww_data = ww_data_to_fit_iid,
  count_data = hosp_data_preprocessed_iid,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = get_mcmc_options(
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling
  ),
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 0
)
# ------------------------------------------------------------------------------
# IID data to Exponential model ------------------------------------------------
fit_iid_to_exp <- wwinference::wwinference(
  ww_data = ww_data_to_fit_iid,
  count_data = hosp_data_preprocessed_iid,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = get_mcmc_options(
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling
  ),
  compiled_model = model,
  dist_matrix = as.matrix(exp_corr_param$dist_matrix),
  corr_structure_switch = 1
)
# ------------------------------------------------------------------------------
# IID data to Unstructured model -----------------------------------------------
fit_iid_to_unstruct <- wwinference::wwinference(
  ww_data = ww_data_to_fit_iid,
  count_data = hosp_data_preprocessed_iid,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = get_mcmc_options(
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling
  ),
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 2
)
# ------------------------------------------------------------------------------
```

## Fitting exponential data
```{r warning=FALSE, message=FALSE}
# Exponential data to IID model ------------------------------------------------
fit_exp_to_iid <- wwinference::wwinference(
  ww_data = ww_data_to_fit_exp,
  count_data = hosp_data_preprocessed_exp,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = get_mcmc_options(
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling
  ),
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 0
)
# ------------------------------------------------------------------------------
# Exponential data to Exponential model ----------------------------------------
fit_exp_to_exp <- wwinference::wwinference(
  ww_data = ww_data_to_fit_exp,
  count_data = hosp_data_preprocessed_exp,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = get_mcmc_options(
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling
  ),
  compiled_model = model,
  dist_matrix = as.matrix(exp_corr_param$dist_matrix),
  corr_structure_switch = 1
)
# ------------------------------------------------------------------------------
# Exponential data to Unstructured model ---------------------------------------
fit_exp_to_unstruct <- wwinference::wwinference(
  ww_data = ww_data_to_fit_exp,
  count_data = hosp_data_preprocessed_exp,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = get_mcmc_options(
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling
  ),
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 2
)
# ------------------------------------------------------------------------------
```

## Fitting rand. corr. matrix data
```{r warning=FALSE, message=FALSE}
# Rand. Corr. Matrix data to IID model -----------------------------------------
fit_rand_to_iid <- wwinference::wwinference(
  ww_data = ww_data_to_fit_rng_corr_mat,
  count_data = hosp_data_proc_rng_corr_mat,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = get_mcmc_options(
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling
  ),
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 0
)
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data to Exponential model ---------------------------------
fit_rand_to_exp <- wwinference::wwinference(
  ww_data = ww_data_to_fit_rng_corr_mat,
  count_data = hosp_data_proc_rng_corr_mat,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = get_mcmc_options(
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling
  ),
  compiled_model = model,
  dist_matrix = as.matrix(exp_corr_param$dist_matrix),
  corr_structure_switch = 1
)
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data to Unstructured model --------------------------------
fit_rand_to_unstruct <- wwinference::wwinference(
  ww_data = ww_data_to_fit_rng_corr_mat,
  count_data = hosp_data_proc_rng_corr_mat,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = get_mcmc_options(
    iter_warmup = iter_warmup,
    iter_sampling = iter_sampling
  ),
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 2
)
# ------------------------------------------------------------------------------
```

## Preparing sampled draws
```{r}
set.seed(2024)
draws_to_keep <- sample(1:max(get_draws_df(fit_iid_to_iid)$draw), 100)
# IID data ---------------------------------------------------------------------
iid_pred_draws_df <- rbind(
  get_draws_df(fit_iid_to_iid) %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws_df(fit_iid_to_exp) %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws_df(fit_iid_to_unstruct) %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "IID"
  )
# ------------------------------------------------------------------------------
# Exponential data -------------------------------------------------------------
exp_pred_draws_df <- rbind(
  get_draws_df(fit_exp_to_iid) %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws_df(fit_exp_to_exp) %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws_df(fit_exp_to_unstruct) %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "Exponential"
  )
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data ------------------------------------------------------
rand_pred_draws_df <- rbind(
  get_draws_df(fit_rand_to_iid) %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws_df(fit_rand_to_exp) %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws_df(fit_rand_to_unstruct) %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "Rand. Corr. Matrix"
  )
# ------------------------------------------------------------------------------
all_pred_draws_df <- rbind(
  iid_pred_draws_df,
  exp_pred_draws_df,
  rand_pred_draws_df
) %>%
  mutate(
    inf_model_type = factor(
      inf_model_type,
      levels = c(
        "Exponential",
        "Unstructured",
        "IID"
      )
    ),
    gen_model_type = factor(
      gen_model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
```

## Preparing sampled draws for correlation matrix
```{r}
# IID data ---------------------------------------------------------------------
iid_corr_matrix_draws_df <- rbind(
  fit_iid_to_iid$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "IID"
    ) %>%
    select(
      -variable
    ),
  fit_iid_to_exp$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Exponential"
    ) %>%
    select(
      -variable
    ),
  fit_iid_to_unstruct$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Unstructured"
    ) %>%
    select(
      -variable
    )
) %>%
  mutate(
    gen_model_type = "IID"
  )
# ------------------------------------------------------------------------------
# Exponential data -------------------------------------------------------------
exp_corr_matrix_draws_df <- rbind(
  fit_exp_to_iid$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "IID"
    ) %>%
    select(
      -variable
    ),
  fit_exp_to_exp$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Exponential"
    ) %>%
    select(
      -variable
    ),
  fit_exp_to_unstruct$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Unstructured"
    ) %>%
    select(
      -variable
    )
) %>%
  mutate(
    gen_model_type = "Exponential"
  )
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data ------------------------------------------------------
rand_corr_matrix_draws_df <- rbind(
  fit_rand_to_iid$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "IID"
    ) %>%
    select(
      -variable
    ),
  fit_rand_to_exp$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Exponential"
    ) %>%
    select(
      -variable
    ),
  fit_iid_to_unstruct$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Unstructured"
    ) %>%
    select(
      -variable
    )
) %>%
  mutate(
    gen_model_type = "Rand. Corr. Matrix"
  )
# ------------------------------------------------------------------------------
all_corr_matrix_draws_df <- rbind(
  iid_corr_matrix_draws_df,
  exp_corr_matrix_draws_df,
  rand_corr_matrix_draws_df
) %>%
  mutate(
    inf_model_type = factor(
      inf_model_type,
      levels = c(
        "IID",
        "Exponential",
        "Unstructured"
      )
    ),
    gen_model_type = factor(
      gen_model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
```


# Visualizing Fits
## Hospital admissions and wastewater
```{r}
# Hospital admissions results --------------------------------------------------
hosp_ribbon_data <- all_pred_draws_df %>%
  filter(
    name == "predicted counts"
  ) %>%
  group_by(
    date,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(pred_value, 0.025, na.rm = TRUE),
    median = median(pred_value),
    upper = quantile(pred_value, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
hosp_result_plot <- ggplot(
  all_pred_draws_df %>%
    filter(
      name == "predicted counts"
    )
) +
  geom_ribbon(
    data = hosp_ribbon_data,
    aes(x = date, ymin = lower, ymax = upper, fill = inf_model_type),
    alpha = 0.1
  ) +
  geom_line(
    data = hosp_ribbon_data,
    aes(x = date, y = median, color = inf_model_type),
    size = 1,
  ) +
  geom_point(
    data = hosp_data_eval_full %>%
      mutate(gen_model_type = model_type),
    aes(x = date, y = daily_hosp_admits_for_eval),
    shape = 21, color = "black", fill = "white"
  ) +
  geom_point(
    aes(x = date, y = observed_value)
  ) +
  geom_vline(aes(xintercept = lubridate::ymd(forecast_date)),
    linetype = "dashed"
  ) +
  xlab("") +
  ylab("Daily hospital admissions") +
  facet_wrap(~gen_model_type, scales = "free_y") +
  guides(
    fill = guide_legend(
      title = "Assumed Corr. Structure"
    ),
    color = guide_legend(
      title = "Assumed Corr. Structure"
    )
  ) +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  theme_bw()
# ------------------------------------------------------------------------------
# Wastewater results -----------------------------------------------------------
ww_ribbon_data <- all_pred_draws_df %>%
  filter(
    name == "predicted wastewater"
  ) %>%
  mutate(
    site_lab_name = glue::glue("{subpop}, Lab: {lab}")
  ) %>%
  group_by(
    date,
    subpop,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(pred_value, 0.025, na.rm = TRUE),
    median = median(pred_value),
    upper = quantile(pred_value, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
ww_result_plot <- ggplot(
  all_pred_draws_df %>%
    filter(
      name == "predicted wastewater"
    )
) +
  geom_ribbon(
    data = ww_ribbon_data,
    aes(x = date, ymin = lower, ymax = upper, fill = inf_model_type),
    alpha = 0.1
  ) +
  geom_line(
    data = ww_ribbon_data,
    aes(x = date, y = median, color = inf_model_type),
    size = 1,
  ) +
  geom_point(
    aes(x = date, y = observed_value)
  ) +
  geom_vline(aes(xintercept = lubridate::ymd(forecast_date)),
    linetype = "dashed"
  ) +
  xlab("") +
  ylab("Genome copies/mL on Log Scale") +
  facet_grid(subpop ~ gen_model_type, scales = "free_y") +
  guides(
    fill = guide_legend(
      title = "Assumed Corr. Structure"
    ),
    color = guide_legend(
      title = "Assumed Corr. Structure"
    )
  ) +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  theme_bw()
# ------------------------------------------------------------------------------

hosp_result_plot / ww_result_plot +
  plot_layout(guides = "collect")
```


## Rt curves, global and site
```{r}
# Global Rt results ------------------------------------------------------------
global_rt_ribbon_data <- all_pred_draws_df %>%
  filter(
    name == "global R(t)"
  ) %>%
  group_by(
    date,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(pred_value, 0.025, na.rm = TRUE),
    median = median(pred_value),
    upper = quantile(pred_value, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
global_rt_result_plot <- ggplot(
  all_pred_draws_df %>%
    filter(
      name == "global R(t)"
    )
) +
  geom_ribbon(
    data = global_rt_ribbon_data,
    aes(x = date, ymin = lower, ymax = upper, fill = inf_model_type),
    alpha = 0.2
  ) +
  geom_line(
    data = global_rt_ribbon_data,
    aes(x = date, y = median, color = inf_model_type),
    size = 1.25,
  ) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    alpha = .7,
    size = 1,
    linetype = "dashed"
  ) +
  geom_line(
    data = rt_global_data_full %>%
      mutate(gen_model_type = model_type),
    aes(x = date, y = global_rt),
    size = 1.25
  ) +
  geom_vline(aes(xintercept = lubridate::ymd(forecast_date)),
    linetype = "dashed"
  ) +
  xlab("") +
  ylab("Global Rt Results") +
  facet_wrap(~gen_model_type, scales = "free_y") +
  guides(
    fill = guide_legend(
      title = "Assumed Corr. Structure"
    ),
    color = guide_legend(
      title = "Assumed Corr. Structure"
    )
  ) +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_y_continuous(trans = "log10") +
  theme_bw()
# ------------------------------------------------------------------------------
# Site Rt results --------------------------------------------------------------
site_rt_ribbon_data <- all_pred_draws_df %>%
  filter(
    name == "subpopulation R(t)"
  ) %>%
  group_by(
    date,
    subpop,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(pred_value, 0.025, na.rm = TRUE),
    median = median(pred_value),
    upper = quantile(pred_value, 0.975, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    subpop = sub(
      pattern = "Site: (\\d+)",
      replacement = "Site \\1",
      x = subpop,
      ignore.case = "remainder of pop"
    )
  ) %>%
  mutate(
    subpop = case_when(
      subpop == "remainder of pop" ~ "Aux",
      .default = subpop
    )
  )
site_rt_result_plot <- ggplot() +
  geom_ribbon(
    data = site_rt_ribbon_data,
    aes(x = date, ymin = lower, ymax = upper, fill = inf_model_type),
    alpha = 0.2
  ) +
  geom_line(
    data = site_rt_ribbon_data,
    aes(x = date, y = median, color = inf_model_type),
    size = 1.25,
  ) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    alpha = .7,
    size = 1,
    linetype = "dashed"
  ) +
  geom_line(
    data = site_rt_data_full %>%
      mutate(gen_model_type = model_type),
    aes(x = date, y = value),
    size = 1.25
  ) +
  geom_vline(
    xintercept = lubridate::ymd(forecast_date),
    linetype = "dashed"
  ) +
  xlab("") +
  ylab("Site Rt") +
  facet_grid(subpop ~ gen_model_type, scales = "free_y") +
  guides(
    fill = guide_legend(
      title = "Assumed Corr. Structure"
    ),
    color = guide_legend(
      title = "Assumed Corr. Structure"
    )
  ) +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_y_continuous(trans = "log10") +
  theme_bw()
# ------------------------------------------------------------------------------

global_rt_result_plot / site_rt_result_plot +
  plot_layout(
    guides = "collect",
    heights = c(1, n_sites)
  )
```

## Correlation matrix
```{r}
# IID Correlation Matrix -------------------------------------------------------
iid_corr_matrix_result_plot <- ggplot(all_corr_matrix_draws_df %>%
  filter(
    gen_model_type == "IID",
    inf_model_type != "IID"
  )) +
  geom_density_ridges(
    aes(
      x = Freq, y = inf_model_type,
      colour = inf_model_type, fill = inf_model_type
    ),
    alpha = .4
  ) +
  geom_vline(
    data = corr_matrix_df %>%
      filter(model_type == "IID") %>%
      mutate(
        Row = Var1,
        Column = Var2
      ),
    aes(xintercept = value),
    color = "red",
    linetype = "dashed",
    size = 1
  ) +
  facet_grid(Row ~ Column, switch = "y") +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  ylab("Assumed Corr. Structure") +
  xlab("Correlation Drawed") +
  ggtitle("Data Generation Model : IID") +
  guides(
    fill = "none",
    color = "none"
  ) +
  theme_bw()
# ------------------------------------------------------------------------------
# Exponential Correlation Matrix -----------------------------------------------
exp_corr_matrix_result_plot <- ggplot(all_corr_matrix_draws_df %>%
  filter(
    gen_model_type == "Exponential",
    inf_model_type != "IID"
  )) +
  geom_density_ridges(
    aes(
      x = Freq, y = inf_model_type,
      colour = inf_model_type, fill = inf_model_type
    ),
    alpha = .4
  ) +
  geom_vline(
    data = corr_matrix_df %>%
      filter(model_type == "Exponential") %>%
      mutate(
        Row = Var1,
        Column = Var2
      ),
    aes(xintercept = value),
    color = "red",
    linetype = "dashed",
    size = 1
  ) +
  facet_grid(Row ~ Column, switch = "y") +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  ylab("Assumed Corr. Structure") +
  xlab("Correlation Drawed") +
  ggtitle("Data Generation Model : Exponential") +
  guides(
    fill = "none",
    color = "none"
  ) +
  theme_bw()
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix Correlation Matrix ----------------------------------------
rand_corr_matrix_result_plot <- ggplot(all_corr_matrix_draws_df %>%
  filter(
    gen_model_type == "Rand. Corr. Matrix",
    inf_model_type != "IID"
  )) +
  geom_density_ridges(
    aes(
      x = Freq, y = inf_model_type,
      colour = inf_model_type, fill = inf_model_type
    ),
    alpha = .4
  ) +
  geom_vline(
    data = corr_matrix_df %>%
      filter(model_type == "Rand. Corr. Matrix") %>%
      mutate(
        Row = Var1,
        Column = Var2
      ),
    aes(xintercept = value),
    color = "red",
    linetype = "dashed",
    size = 1
  ) +
  facet_grid(Row ~ Column, switch = "y") +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  ylab("Assumed Corr. Structure") +
  xlab("Correlation Drawed") +
  ggtitle("Data Generation Model : Rand. Corr. Matrix") +
  guides(
    fill = "none",
    color = "none"
  ) +
  theme_bw()
# ------------------------------------------------------------------------------

iid_corr_matrix_result_plot + exp_corr_matrix_result_plot +
  rand_corr_matrix_result_plot
```



# Numeric Results

```{r}
# ess / sec #nolint
fit_names <- list(
  fit_iid_to_iid, fit_iid_to_exp, fit_iid_to_unstruct,
  fit_exp_to_iid, fit_exp_to_exp, fit_exp_to_unstruct,
  fit_rand_to_iid, fit_rand_to_exp, fit_rand_to_unstruct
)
gen_names <- c(
  "IID", "IID", "IID",
  "Exponential", "Exponential", "Exponential",
  "Rand. Corr. Matrix", "Rand. Corr. Matrix", "Rand. Corr. Matrix"
)
inf_names <- c(
  "IID", "Exponential", "Unstructured",
  "IID", "Exponential", "Unstructured",
  "IID", "Exponential", "Unstructured"
)
ess_per_sec_df <- data.frame(
  model = rep(0, 9),
  gen_model_type = rep(0, 9),
  ess_per_sec = rep(0, 9)
)
for (i in 1:9) {
  curr_fit <- fit_names[[i]]
  ess_per_sec_df$gen_model_type[i] <- gen_names[i]
  ess_per_sec_df$model[i] <- inf_names[i]
  ess_per_sec_df$ess_per_sec[i] <- mean(
    curr_fit$fit$result$summary()$ess_bulk,
    na.rm = TRUE
  ) / curr_fit$fit$result$time()$total
}
```

## Hospital admissions

### Hospital admissions at forecast period evaluation scores
```{r}
hosp_obj_for_eval_forcast <- all_pred_draws_df %>%
  filter(
    name == "predicted counts",
    date > forecast_date
  ) %>%
  inner_join(
    hosp_data_eval_full %>%
      filter(
        date > forecast_date
      ) %>%
      mutate(
        gen_model_type = model_type,
        true_value = daily_hosp_admits_for_eval
      ) %>%
      select(
        date,
        true_value,
        gen_model_type
      ),
    by = c("date", "gen_model_type")
  ) %>%
  mutate(
    prediction = pred_value,
    sample = draw,
    model = inf_model_type
  ) %>%
  select(
    prediction,
    true_value,
    sample,
    date,
    model,
    gen_model_type
  )

hosp_scores_forecast <- hosp_obj_for_eval_forcast %>%
  score(metrics = c(
    "log_score",
    "crps",
    "dss",
    "ae_median",
    "se_mean",
    "bias"
  ))

hosp_by_date_eval_forecast_plot <- ggplot( # nolint
  hosp_scores_forecast %>%
    pivot_longer(
      cols = -c("date", "model", "gen_model_type"),
      names_to = "Evaluation Score",
      values_to = "Score"
    ) %>%
    mutate(
      `Evaluation Score` = case_when(
        `Evaluation Score` == "crps" ~ "CRPS",
        `Evaluation Score` == "dss" ~ "Dawid-Sebastiani Score",
        `Evaluation Score` == "ae_median" ~ "Absolute Error",
        `Evaluation Score` == "se_mean" ~ "Squared Error",
        `Evaluation Score` == "bias" ~ "Bias",
        .default = `Evaluation Score`
      )
    ) %>%
    mutate(
      model = factor(
        model,
        levels = c(
          "IID",
          "Exponential",
          "Unstructured"
        )
      )
    )
) +
  geom_point(
    aes(x = date, y = Score, colour = model)
  ) +
  geom_line(
    aes(x = date, y = Score, colour = model)
  ) +
  facet_grid2(`Evaluation Score` ~ gen_model_type,
    scales = "free",
    independent = "y"
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  labs(color = "Assumed Corr. Structure") +
  ggtitle("Hospital Admission Forecast Period Evaluation Metric By Date") +
  ylab("Score") +
  xlab("Date") +
  theme_bw()


hosp_eval_forecast_plot <- ggplot(
  hosp_scores_forecast %>%
    summarize_scores(by = c("model", "gen_model_type")) %>%
    pivot_longer(
      cols = -c("model", "gen_model_type"),
      names_to = "Evaluation Score",
      values_to = "Score"
    ) %>%
    mutate(
      `Evaluation Score` = case_when(
        `Evaluation Score` == "crps" ~ "CRPS",
        `Evaluation Score` == "dss" ~ "Dawid-Sebastiani Score",
        `Evaluation Score` == "ae_median" ~ "Absolute Error",
        `Evaluation Score` == "se_mean" ~ "Squared Error",
        `Evaluation Score` == "bias" ~ "Bias",
        .default = `Evaluation Score`
      )
    ) %>%
    group_by(gen_model_type, `Evaluation Score`) %>%
    mutate(
      scaled_score = (Score - min(Score)) / (max(Score) - min(Score))
    ) %>%
    ungroup() %>%
    mutate(
      model = factor(
        model,
        levels = c(
          "IID",
          "Exponential",
          "Unstructured"
        )
      )
    )
) +
  geom_tile(
    aes(x = model, y = `Evaluation Score`, fill = scaled_score),
    color = "black"
  ) +
  geom_text(
    aes(
      x = model,
      y = `Evaluation Score`,
      label = sprintf("%.2f", Score)
    ),
    color = "black",
    size = 3.5
  ) +
  facet_wrap(~gen_model_type) +
  scale_fill_gradient(
    low = "white",
    high = "dodgerblue"
  ) +
  guides(fill = "none") +
  labs(fill = "Score Relative to Metric") +
  ggtitle("Hospital Admission Forecast Period Evaluation Metric") +
  ylab("Evalutation Metric") +
  xlab("Assumed Correlation Structure") +
  theme_bw()
```

```{r}
# Raw Scores :
hosp_scores_forecast %>%
  summarize_scores(by = c("model", "gen_model_type"))
```


### Hospital admissions at nowcasting period evaluation scores
```{r}
hosp_obj_for_eval_nowcast <- all_pred_draws_df %>%
  filter(
    name == "predicted counts",
    date > max(hosp_data$date),
    date <= forecast_date
  ) %>%
  inner_join(
    hosp_data_eval_full %>%
      filter(
        date > max(hosp_data$date),
        date <= forecast_date
      ) %>%
      mutate(
        gen_model_type = model_type,
        true_value = daily_hosp_admits_for_eval
      ) %>%
      select(
        date,
        true_value,
        gen_model_type
      ),
    by = c("date", "gen_model_type")
  ) %>%
  mutate(
    prediction = pred_value,
    sample = draw,
    model = inf_model_type
  ) %>%
  select(
    prediction,
    true_value,
    sample,
    date,
    model,
    gen_model_type
  )

hosp_scores_nowcast <- hosp_obj_for_eval_nowcast %>%
  score(metrics = c(
    "log_score",
    "crps",
    "dss",
    "ae_median",
    "se_mean",
    "bias"
  ))

hosp_by_date_eval_nowcast_plot <- ggplot(
  hosp_scores_nowcast %>%
    pivot_longer(
      cols = -c("date", "model", "gen_model_type"),
      names_to = "Evaluation Score",
      values_to = "Score"
    ) %>%
    mutate(
      `Evaluation Score` = case_when(
        `Evaluation Score` == "crps" ~ "CRPS",
        `Evaluation Score` == "dss" ~ "Dawid-Sebastiani Score",
        `Evaluation Score` == "ae_median" ~ "Absolute Error",
        `Evaluation Score` == "se_mean" ~ "Squared Error",
        `Evaluation Score` == "bias" ~ "Bias",
        .default = `Evaluation Score`
      )
    ) %>%
    mutate(
      model = factor(
        model,
        levels = c(
          "IID",
          "Exponential",
          "Unstructured"
        )
      )
    )
) +
  geom_point(
    aes(x = date, y = Score, colour = model)
  ) +
  geom_line(
    aes(x = date, y = Score, colour = model)
  ) +
  facet_grid2(`Evaluation Score` ~ gen_model_type,
    scales = "free",
    independent = "y"
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  labs(color = "Assumed Corr. Structure") +
  ggtitle("Hospital Admission Nowcast Period Evaluation Metric By Date") +
  ylab("Score") +
  xlab("Date") +
  theme_bw()


hosp_eval_nowcast_plot <- ggplot(
  hosp_scores_nowcast %>%
    summarize_scores(by = c("model", "gen_model_type")) %>%
    pivot_longer(
      cols = -c("model", "gen_model_type"),
      names_to = "Evaluation Score",
      values_to = "Score"
    ) %>%
    mutate(
      `Evaluation Score` = case_when(
        `Evaluation Score` == "crps" ~ "CRPS",
        `Evaluation Score` == "dss" ~ "Dawid-Sebastiani Score",
        `Evaluation Score` == "ae_median" ~ "Absolute Error",
        `Evaluation Score` == "se_mean" ~ "Squared Error",
        `Evaluation Score` == "bias" ~ "Bias",
        .default = `Evaluation Score`
      )
    ) %>%
    group_by(gen_model_type, `Evaluation Score`) %>%
    mutate(
      scaled_score = (Score - min(Score)) / (max(Score) - min(Score))
    ) %>%
    ungroup() %>%
    mutate(
      model = factor(
        model,
        levels = c(
          "IID",
          "Exponential",
          "Unstructured"
        )
      )
    )
) +
  geom_tile(
    aes(x = model, y = `Evaluation Score`, fill = scaled_score),
    color = "black"
  ) +
  geom_text(
    aes(
      x = model,
      y = `Evaluation Score`,
      label = sprintf("%.2f", Score)
    ),
    color = "black",
    size = 3.5
  ) +
  facet_wrap(~gen_model_type) +
  scale_fill_gradient(
    low = "white",
    high = "dodgerblue"
  ) +
  guides(fill = "none") +
  labs(fill = "Score Relative to Metric") +
  ggtitle("Hospital Admission Nowcast Period Evaluation Metric") +
  ylab("Evalutation Metric") +
  xlab("Assumed Correlation Structure") +
  theme_bw()
```

```{r}
# Raw Scores :
hosp_scores_nowcast %>%
  summarize_scores(by = c("model", "gen_model_type"))
```


### Hospital admissions evaluation scores plot
```{r}
(hosp_eval_nowcast_plot + hosp_eval_forecast_plot) /
  (hosp_by_date_eval_nowcast_plot + hosp_by_date_eval_forecast_plot) +
  plot_layout(guides = "collect")
```
