---
title: "Assessing the value of adding a spatial correlation structure."
description: "Here we showcase how we can add a site to site correlations."
author: "Christian O. Bernal Zelaya"
date: "2024-09-13"
output:
  html_document:
    fig_width: 15
    fig_height: 12
    number_sections: true
    toc: true
    toc_depth: 1
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r echo=FALSE}
knitr::opts_chunk$set(dev = "svg")
```

<script type="text/javascript">
$(document).ready(function() {

  $chunks = $('.fold');

  $chunks.each(function () {

    // Add button to source code chunks
    if ( $(this).hasClass('s') ) {
      $('pre.r', this).prepend("<div class=\"showopt\">Hide Source</div><br style=\"line-height:22px;\"/>");
      $('pre.r', this).children('code').removeClass('folded'); // Default to show code
    }

    // Add button to output chunks
    if ( $(this).hasClass('o') ) {
      $('pre:not(.r)', this).has('code').prepend("<div class=\"showopt\">Show Output</div><br style=\"line-height:22px;\"/>");
      $('pre:not(.r)', this).children('code:not(r)').addClass('folded'); // Default to hide output

      // Add button to plots
      $(this).find('img').wrap('<pre class=\"plot\"></pre>');
      $('pre.plot', this).prepend("<div class=\"showopt\">Show Plot</div><br style=\"line-height:22px;\"/>");
      $('pre.plot', this).children('img').addClass('folded'); // Default to hide plots

    }
  });

  // Hide all chunks when document is loaded
  $('.folded').css('display', 'none');

  // Function to toggle the visibility
  $('.showopt').click(function() {
    var label = $(this).html();
    if (label.indexOf("Show") >= 0) {
      $(this).html(label.replace("Show", "Hide"));
    } else {
      $(this).html(label.replace("Hide", "Show"));
    }
    $(this).siblings('code, img').slideToggle('fast', 'swing');
  });
});
</script>

<style>
.showopt {
  background-color: #004c93;
  color: #FFFFFF;
  width: 100px;
  height: 20px;
  text-align: center;
  vertical-align: middle !important;
  float: right;
  font-family: sans-serif;
  border-radius: 8px;
  cursor: pointer; /* Add cursor pointer for better UX */
}

.showopt:hover {
  background-color: #dfe4f2;
  color: #004c93;
}

pre.plot {
  background-color: white !important;
}
</style>

# Start
Here we present a workflow to simulate and fit three separate models using
the `wwinference` package.  We also compare the results a number of ways to see
the value of using spatial components within the model.

<div class="fold s">
```{r warning=FALSE, message=FALSE}
library(wwinference)
library(dplyr)
library(tibble)
library(tidyr)
library(ggplot2)
library(patchwork)
library(scoringutils)
library(ggh4x) # for facet_grid2
```


# Generating Data

We start by generating the data that our models require, using the
`generate_simulated_data()` function.  The presets that are required to use the
spatial components are `use_spatial_corr = TRUE` and `aux_site_bool = TRUE`.
We also require that if `use_spatial_corr = TRUE`, the user must specify a
correlation function in the `corr_function` and the necessary parameters of the
function in `corr_fun_params`.  Currently we have three built in functions for
correlation types : `independence_corr_func_r()`,
`exponential_decay_corr_func_r()`, and `rand_corr_matrix_func()`.  The default
used is `exponential_decay_corr_func_r()` correlation function based of the
following fake locations.

## Fake locations
Since we want to explore the usefulness of including spatial information into
the wastewater informed inference model, we must first generate fake locations
that serve as the wastewater treatment plant locations.  Here we randomly place
four wastewater treatment plants.

<div class="fold s">
```{r fig.height=6, fig.width=6}
set.seed(2024)
n_sites <- 4
fake_locs <- data.frame(
  x = runif(n_sites, 0, 100),
  y = runif(n_sites, 0, 100),
  ID = paste0("Site ", 1:n_sites)
)
fake_locs_plot <- ggplot(
  data = fake_locs
) +
  geom_point(
    aes(x = x, y = y),
    color = "blue",
    size = 5
  ) +
  geom_text(
    aes(label = ID, x = x, y = y),
    vjust = -1
  ) +
  coord_cartesian(
    xlim = c(min(fake_locs$x) - 2, max(fake_locs$x) + 2),
    ylim = c(min(fake_locs$y) - 2, max(fake_locs$y) + 2)
  ) +
  labs(
    title = "Fake Locations",
    x = "X Coordinate",
    y = "Y Coordinate"
  ) +
  theme_bw()

fake_locs_plot
```

## Central Rt Curve
Another requirement that we need to have based on the model definition, is a
central $\mathcal{R}(t)$ curve that is the underlining central infection
dynamic.  Here we visualize the central $\mathcal{R}(t)$ curve that is used in
this vignette, but any central $\mathcal{R}(t)$ can be used here.

<div class="fold s">
```{r}
r_in_weeks <- c(
  rep(1.1, 5), rep(0.9, 5),
  0.9 + 0.0005 * (1:16)^2
)
lng <- length(r_in_weeks)
central_rt_curve <- ggplot() +
  geom_line(
    aes(
      x = 1:lng,
      y = r_in_weeks
    )
  ) +
  geom_point(
    aes(
      x = 1:lng,
      y = r_in_weeks
    )
  ) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    linetype = "dashed",
    alpha = .7
  ) +
  scale_y_continuous(transform = "log10") +
  xlab("Week") +
  ylab("Rt Value") +
  ggtitle("Central Rt curve") +
  theme_bw()

central_rt_curve
```

## Simulating data
Now we simulate the data with three different data generation models.  The
difference between these will be the correlation structure that is used for
site to site correlations.  We will have an iid (imposes no correlations),
exponential decay correlation function based off distance matrix, and a random
correlation matrix structure (site to site correlations, but based off
something we are not aware of).  We also set the necessary presets for our
simulations.  These presets include site names, lab names, wastewater treatment
plant populations, total population, the global $\mathcal{R}(t)$ standard
deviation (we set this to zero to ensure central $\mathcal{R}(t)$ is used
without any deviations), and necessary correlation function parameters.  The
type of correlation structure can be changed by setting `corr_function` to one
of three functions included in the package : `independence_corr_func_r`,
`exponential_decay_corr_func_r()`, and `rand_corr_matrix_func()`.  Each
correlation matrix function, built in or user created, expects a set of
parameters `corr_fun_params` that are specific to that function.  See each built
in function's documentation for details on how to set these parameters.  Under
the hood, the correlation matrix is created by calling
`corr_function(corr_fun_params)`.  So, `corr_function` and `corr_fun_params`
need to be set to work in sync.  The object that comes out of
`generate_simulated_data()` will have hospital admission data, hospital
admission data for eval, site-level wastewater concentration data, and global
and site level $\mathcal{R}(t)$'s.

<div class="fold s">
```{r warning=FALSE, message=FALSE}
# Presets ----------------------------------------------------------------------
site <- 1:n_sites
lab <- rep(1, n_sites)
ww_pop_sites <- c(5e5, 7.5e5, 3.8e5, 4.5e5)
pop_size <- 2 * sum(ww_pop_sites)
global_rt_sd <- 0
exp_corr_param <- list(
  dist_matrix = as.matrix(
    dist(
      data.frame(
        x = fake_locs$x,
        y = fake_locs$y
      ),
      diag = TRUE,
      upper = TRUE
    )
  ),
  phi = 0.4,
  l = 1
)
sigma_sqrd_generalized <- 0.01^n_sites
# ------------------------------------------------------------------------------
# IID Simulated Data -----------------------------------------------------------
simulated_data_iid <- withr::with_seed(1, {
  wwinference::generate_simulated_data(
    r_in_weeks = r_in_weeks, # nolint
    n_sites = n_sites,
    site = site,
    lab = lab,
    ww_pop_sites = ww_pop_sites,
    pop_size = pop_size,
    global_rt_sd = global_rt_sd,
    use_spatial_corr = TRUE,
    corr_function = wwinference::independence_corr_func_r,
    corr_fun_params = list(num_sites = n_sites),
    sigma_sqrd_generalized = sigma_sqrd_generalized,
    aux_site_bool = TRUE
  )
})
# ------------------------------------------------------------------------------
# Exponential Simulated Data ---------------------------------------------------
simulated_data_exp <- withr::with_seed(1, {
  wwinference::generate_simulated_data(
    r_in_weeks = r_in_weeks, # nolint
    n_sites = n_sites,
    site = site,
    lab = lab,
    ww_pop_sites = ww_pop_sites,
    pop_size = pop_size,
    global_rt_sd = global_rt_sd,
    use_spatial_corr = TRUE,
    corr_function = exponential_decay_corr_func_r,
    corr_fun_params = exp_corr_param,
    sigma_sqrd_generalized = sigma_sqrd_generalized,
    aux_site_bool = TRUE
  )
})
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix Simulated Data --------------------------------------------
simulated_data_rng_corr_mat <- withr::with_seed(1, {
  wwinference::generate_simulated_data(
    r_in_weeks = r_in_weeks, # nolint
    n_sites = n_sites,
    site = site,
    lab = lab,
    ww_pop_sites = ww_pop_sites,
    pop_size = pop_size,
    global_rt_sd = global_rt_sd,
    use_spatial_corr = TRUE,
    corr_function = wwinference::rand_corr_matrix_func,
    corr_fun_params = list(n_sites = n_sites, seed = 2024),
    sigma_sqrd_generalized = sigma_sqrd_generalized,
    aux_site_bool = TRUE
  )
})
# ------------------------------------------------------------------------------
```

## Preparing data
Here we take the output of the `generate_simulated_data()` and prepare it for
the `wwinference()` function that does the fitting to an inference model.

<div class="fold s">
```{r}
# iid case
hosp_data_preprocessed_iid <- wwinference::preprocess_count_data(
  simulated_data_iid$hosp_data,
  count_col_name = "daily_hosp_admits",
  pop_size_col_name = "state_pop"
)
ww_data_preprocessed_iid <- wwinference::preprocess_ww_data(
  simulated_data_iid$ww_data
)
ww_data_to_fit_iid <- wwinference::indicate_ww_exclusions(
  ww_data_preprocessed_iid,
  outlier_col_name = "flag_as_ww_outlier",
  remove_outliers = TRUE
)

# exponential case
hosp_data_preprocessed_exp <- wwinference::preprocess_count_data(
  simulated_data_exp$hosp_data,
  count_col_name = "daily_hosp_admits",
  pop_size_col_name = "state_pop"
)
ww_data_preprocessed_exp <- wwinference::preprocess_ww_data(
  simulated_data_exp$ww_data
)
ww_data_to_fit_exp <- wwinference::indicate_ww_exclusions(
  ww_data_preprocessed_exp,
  outlier_col_name = "flag_as_ww_outlier",
  remove_outliers = TRUE
)

# rand corr mat case
hosp_data_proc_rng_corr_mat <- wwinference::preprocess_count_data(
  simulated_data_rng_corr_mat$hosp_data,
  count_col_name = "daily_hosp_admits",
  pop_size_col_name = "state_pop"
)
ww_data_proc_rng_corr_mat <- wwinference::preprocess_ww_data(
  simulated_data_rng_corr_mat$ww_data
)
ww_data_to_fit_rng_corr_mat <- wwinference::indicate_ww_exclusions(
  ww_data_proc_rng_corr_mat,
  outlier_col_name = "flag_as_ww_outlier",
  remove_outliers = TRUE
)
```

## Visualizing
With all of the data ready to fit, we first visualize the data we simulated
under each of the data generation models.  We visualize using the `ggplot2`
package.

### Visualizing data
We start with visualizing the hospital and wastewater data.  Here open circles
represent the retrospectively observed data that will be used to evaluate the
nowcasting and forecasting periods.  The data that will be fed into the model
will be the solid dots in the plots.  We separate these plots by their data
generation models, this will be consistent across all plots.  We also separate
the wastewater plots by their site, with the dotted lines representing the
limit of detection in that site and lab.

<div class="fold s">
```{r}
# hosp plots--------------------------------------------------------------------
hosp_data_full <- rbind(
  hosp_data_preprocessed_iid %>%
    mutate(model_type = "IID"),
  hosp_data_preprocessed_exp %>%
    mutate(model_type = "Exponential"),
  hosp_data_proc_rng_corr_mat %>%
    mutate(model_type = "Rand. Corr. Matrix")
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
hosp_data_eval_full <- rbind(
  simulated_data_iid$hosp_data_eval %>%
    mutate(model_type = "IID"),
  simulated_data_exp$hosp_data_eval %>%
    mutate(model_type = "Exponential"),
  simulated_data_rng_corr_mat$hosp_data_eval %>%
    mutate(model_type = "Rand. Corr. Matrix")
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
hosp_data_plot <- ggplot(hosp_data_full) +
  geom_point(
    data = hosp_data_eval_full, aes(
      x = date,
      y = daily_hosp_admits_for_eval
    ),
    shape = 21, color = "black", fill = "white"
  ) +
  # Plot the data we will calibrate to
  geom_point(aes(x = date, y = count)) +
  xlab("") +
  ylab("Daily hospital admissions") +
  facet_wrap(~model_type, scales = "free_y") +
  theme_bw()
# ------------------------------------------------------------------------------

# ww plots----------------------------------------------------------------------
ww_data_full <- rbind(
  ww_data_preprocessed_iid %>%
    mutate(model_type = "IID"),
  ww_data_preprocessed_exp %>%
    mutate(model_type = "Exponential"),
  ww_data_proc_rng_corr_mat %>%
    mutate(model_type = "Rand. Corr. Matrix")
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
ww_data_eval_full <- rbind(
  simulated_data_iid$ww_data_eval %>%
    mutate(model_type = "IID"),
  simulated_data_exp$ww_data_eval %>%
    mutate(model_type = "Exponential"),
  simulated_data_rng_corr_mat$ww_data_eval %>%
    mutate(model_type = "Rand. Corr. Matrix")
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
ww_data_plot <- ggplot(ww_data_full) +
  geom_point(
    data = ww_data_eval_full, aes(
      x = date,
      y = log_genome_copies_per_ml_eval
    ),
    shape = 21, color = "black", fill = "white"
  ) +
  geom_point(
    aes(
      x = date, y = log_genome_copies_per_ml
    ),
    show.legend = FALSE
  ) +
  geom_hline(aes(yintercept = log_lod), linetype = "dashed") +
  facet_grid(~model_type,
    scales = "fixed",
    labeller = labeller(site = function(x) paste("Site", x))
  ) +
  xlab("") +
  ylab("Genome copies/mL on Log Scale") +
  theme_bw()
# ------------------------------------------------------------------------------

hosp_data_plot / ww_data_plot +
  plot_layout(heights = c(1, 2))
```

We might also want to visualize what the combined wastewater data looks like,
which we do here.  Colors correspond to the treatment plant that wastewater
came from.  We still have that the dotted line is the limit of detection.  A
couple of things that we should expect to see is that sites that are closer
together in the fake locations plot should have similar trends.

```{r}
ww_total_plot <- ggplot(ww_data_full) +
  geom_line(
    aes(
      x = date, y = log_genome_copies_per_ml,
      colour = factor(site)
    )
  ) +
  geom_point(
    aes(
      x = date, y = log_genome_copies_per_ml,
      colour = factor(site)
    )
  ) +
  geom_hline(
    aes(yintercept = log_lod, colour = factor(site)),
    linetype = "dashed"
  ) +
  facet_grid(
    ~model_type,
    scales = "fixed"
  ) +
  scale_color_manual(
    breaks = c("1", "2", "3", "4"),
    values = c(
      "darkviolet", "darkgreen",
      "darkred", "darkorange"
    )
  ) +
  xlab("") +
  ylab("Genome copies/mL on log scale") +
  labs(color = "Site") +
  theme_bw()
ww_total_plot
```

### Visualizing actual $\mathcal{R}(t)$ curves
Here we visualize both the global and site level $\mathcal{R}(t)$ curves.  We
have facets for each of the data generation models.  We also look at a site
called the Aux site, which, per the model definition, is the population that is
not captured by a wastewater treatment plant.  We include a blue horizontal line
at $\mathcal{R}(t)$ = 1 to denote when infections should be increasing
$(\mathcal{R}(t) > 1)$ or decreasing $(\mathcal{R}(t) < 1)$.

For these site level $\mathcal{R}(t)$'s, refer to the model definition.

<div class="fold s">
```{r}
# Global Rt --------------------------------------------------------------------
rt_global_data_full <- rbind(
  simulated_data_iid$rt_global_data %>%
    as.data.frame() %>%
    `colnames<-`(c("global_rt")) %>%
    mutate(
      model_type = "IID",
      date = simulated_data_iid$hosp_data_eval$date
    ),
  simulated_data_exp$rt_global_data %>%
    as.data.frame() %>%
    `colnames<-`(c("global_rt")) %>%
    mutate(
      model_type = "Exponential",
      date = simulated_data_exp$hosp_data_eval$date
    ),
  simulated_data_rng_corr_mat$rt_global_data %>%
    as.data.frame() %>%
    `colnames<-`(c("global_rt")) %>%
    mutate(
      model_type = "Rand. Corr. Matrix",
      date = simulated_data_rng_corr_mat$hosp_data_eval$date
    )
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
global_rt_data_plot <- ggplot(rt_global_data_full) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    linetype = "dashed",
    alpha = .7
  ) +
  geom_line(aes(
    x = date,
    y = (global_rt),
  )) +
  scale_y_continuous(transform = "log10") +
  xlab("") +
  ylab("Global R(t)") +
  facet_grid(~model_type) +
  theme_bw()
# ------------------------------------------------------------------------------

# Site Rt ----------------------------------------------------------------------
site_rt_data_full <- rbind(
  simulated_data_iid$rt_site_data %>%
    t() %>%
    as.data.frame() %>%
    mutate(date = simulated_data_iid$hosp_data_eval$date) %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites),
      "Aux",
      "date"
    )) %>%
    pivot_longer(cols = -date) %>%
    `colnames<-`(c(
      "date",
      "subpop",
      "value"
    )) %>%
    mutate(
      model_type = "IID"
    ),
  simulated_data_exp$rt_site_data %>%
    t() %>%
    as.data.frame() %>%
    mutate(date = simulated_data_exp$hosp_data_eval$date) %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites),
      "Aux",
      "date"
    )) %>%
    pivot_longer(cols = -date) %>%
    `colnames<-`(c(
      "date",
      "subpop",
      "value"
    )) %>%
    mutate(
      model_type = "Exponential"
    ),
  simulated_data_rng_corr_mat$rt_site_data %>%
    t() %>%
    as.data.frame() %>%
    mutate(date = simulated_data_rng_corr_mat$hosp_data_eval$date) %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites),
      "Aux",
      "date"
    )) %>%
    pivot_longer(cols = -date) %>%
    `colnames<-`(c(
      "date",
      "subpop",
      "value"
    )) %>%
    mutate(
      model_type = "Rand. Corr. Matrix"
    )
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
site_rt_data_plot <- ggplot(site_rt_data_full) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    linetype = "dashed",
    alpha = .7
  ) +
  geom_line(aes(
    x = date,
    y = (value)
  )) +
  facet_grid(subpop ~ model_type) +
  scale_y_continuous(transform = "log10") +
  xlab("") +
  ylab("Subpopulation R(t)") +
  theme_bw()

# ------------------------------------------------------------------------------

global_rt_data_plot / site_rt_data_plot +
  plot_layout(heights = c(1, n_sites))
```

Similarly we can visualize the combined site level $\mathcal{R}(t)$ curves.
Colors are the different sites.  One thing to also note is that we should expect
to see sites that are highly correlated with each other should have very similar
curves.  The correlations plot can be seen in the next section.

```{r fig.height=5, fig.width=10}
site_rt_total_plot <- ggplot(site_rt_data_full) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    linetype = "dashed",
    alpha = .7
  ) +
  geom_line(aes(
    x = date, y = value,
    colour = factor(subpop)
  )) +
  facet_grid(~model_type,
    scales = "fixed"
  ) +
  scale_color_manual(
    breaks = c(
      "Site 1", "Site 2", "Site 3", "Site 4", "Aux"
    ),
    values = c(
      "darkviolet", "darkgreen",
      "darkred", "darkorange", "grey"
    )
  ) +
  scale_y_continuous(transform = "log10") +
  xlab("") +
  ylab("Subpopulation R(t)") +
  labs(color = "Sites") +
  theme_bw()

site_rt_total_plot
```


### Visual of correlation matrix
One other thing that we want to visualize, because it is the key difference
between the data generation models, is the site to site correlation matrix.
Here we facet by data generation model and visualize site-site correlations
using both color and area of the circle. To remind ourselves, IID will have no
correlations between wastewater sites.  Exponential will have correlations
between wastewater sites that are a function of the distance between the
centroids of the sites, with closer sited being more highly correlated.  Rand.
Corr. Matrix will have correlations between wastewater treatment plants that are
based off some unknown factors, to emulate this we just set random correlations
between sites.

<div class="fold s">
```{r fig.height=5, fig.width=10}
# Correlation Visuals ----------------------------------------------------------
corr_matrix_df <- rbind(
  simulated_data_iid$corr_matrix %>%
    as.data.frame() %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    `rownames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    rownames_to_column(var = "Var1") %>%
    pivot_longer(
      -Var1,
      names_to = "Var2",
      values_to = "value"
    ) %>%
    mutate(
      model_type = "IID"
    ),
  simulated_data_exp$corr_matrix %>%
    as.data.frame() %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    `rownames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    rownames_to_column(var = "Var1") %>%
    pivot_longer(
      -Var1,
      names_to = "Var2",
      values_to = "value"
    ) %>%
    mutate(
      model_type = "Exponential"
    ),
  simulated_data_rng_corr_mat$corr_matrix %>%
    as.data.frame() %>%
    `colnames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    `rownames<-`(c(
      paste0("Site ", 1:n_sites)
    )) %>%
    rownames_to_column(var = "Var1") %>%
    pivot_longer(
      -Var1,
      names_to = "Var2",
      values_to = "value"
    ) %>%
    mutate(
      model_type = "Rand. Corr. Matrix"
    )
) %>%
  mutate(
    model_type = factor(
      model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  ) %>%
  mutate(
    Var2 = factor(
      Var2,
      levels = paste0("Site ", n_sites:1)
    )
  )
corr_matrix_plot <- ggplot(corr_matrix_df, aes(Var1, Var2)) +
  geom_point(
    aes(size = abs(value), fill = value),
    shape = 21,
    color = "black"
  ) +
  scale_fill_gradient2(
    low = "darkblue",
    high = "darkred",
    mid = "white",
    midpoint = 0,
    limit = c(-1, 1),
    space = "Lab",
    name = "Correlation"
  ) +
  scale_size(
    range = c(1, 10),
    guide = "none"
  ) +
  scale_x_discrete(position = "top") +
  coord_fixed() +
  ylab("") +
  xlab("") +
  facet_grid(~model_type, switch = "x") +
  ggtitle("Correlation Matrix Visuals") +
  theme_bw()
# ------------------------------------------------------------------------------

corr_matrix_plot
```


# Fitting Data
We now show how we can fit different types of models to the data.  We currently
only have three spatial structures to choose from when using the `wwinference()`
model.  Those are iid, for non-spatial assumptions where we infer only a common
generalized variance, exponential correlation function based off distances of
subpopulations or sites where we infer the parameters of the correlation
function, and unstructured where the entire correlation matrix is inferred.  The
switch required to change from each type is `corr_structure_switch` in the
`wwinference()` function.  Inputs for this switch are currently, `0` - iid,
`1` - exponential, and `2` - unstructured.  Keep in mind that if exponential is
used, a distance matrix is required as input as well.

## Fitting presets
We start by getting necessary inference model parameters and we also set a
couple of presets, these being the forecast date, calibration time, forecast
horizon, generation interval, infection to hospitalization distribution,
infection feedback distribution, stan file, and stan warmup and sampling
iterations.  Some of these are required to preset to run the model, but some
have defaults, be sure to look over documentation of functions for more details.

<div class="fold s">
```{r warning=FALSE, message=FALSE}
params <- get_params(
  system.file("extdata", "example_params.toml",
    package = "wwinference"
  )
)
forecast_date <- "2023-12-06"
calibration_time <- 90
forecast_horizon <- 28

generation_interval <- wwinference::default_covid_gi
inf_to_hosp <- wwinference::default_covid_inf_to_hosp

# Assign infection feedback equal to the generation interval
infection_feedback_pmf <- generation_interval

model <- wwinference::compile_model()

iter_warmup <- 250
iter_sampling <- 500
fit_options <- get_mcmc_options(
  iter_warmup = iter_warmup,
  iter_sampling = iter_sampling,
  seed = 123
)
```

## Fitting iid data
We start with fitting the data generated from the IID model to the three types
of inference models.  These three types of inference models are differing only
by their assumed correlation structure, as mentioned above.

<div class="fold s o">
```{r warning=FALSE, message=FALSE}
# IID data to IID model --------------------------------------------------------
fit_iid_to_iid <- wwinference::wwinference(
  ww_data = ww_data_to_fit_iid,
  count_data = hosp_data_preprocessed_iid,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = fit_options,
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 0
)
# ------------------------------------------------------------------------------
# IID data to Exponential model ------------------------------------------------
fit_iid_to_exp <- wwinference::wwinference(
  ww_data = ww_data_to_fit_iid,
  count_data = hosp_data_preprocessed_iid,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = fit_options,
  compiled_model = model,
  dist_matrix = as.matrix(exp_corr_param$dist_matrix),
  corr_structure_switch = 1
)
# ------------------------------------------------------------------------------
# IID data to Unstructured model -----------------------------------------------
fit_iid_to_unstruct <- wwinference::wwinference(
  ww_data = ww_data_to_fit_iid,
  count_data = hosp_data_preprocessed_iid,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = fit_options,
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 2
)
```

## Fitting exponential data
We proceed to fit the exponential data generation model to the three types of
inference models.

<div class="fold s o">
```{r warning=FALSE, message=FALSE}
# Exponential data to IID model ------------------------------------------------
fit_exp_to_iid <- wwinference::wwinference(
  ww_data = ww_data_to_fit_exp,
  count_data = hosp_data_preprocessed_exp,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = fit_options,
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 0
)
# ------------------------------------------------------------------------------
# Exponential data to Exponential model ----------------------------------------
fit_exp_to_exp <- wwinference::wwinference(
  ww_data = ww_data_to_fit_exp,
  count_data = hosp_data_preprocessed_exp,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = fit_options,
  compiled_model = model,
  dist_matrix = as.matrix(exp_corr_param$dist_matrix),
  corr_structure_switch = 1
)
# ------------------------------------------------------------------------------
# Exponential data to Unstructured model ---------------------------------------
fit_exp_to_unstruct <- wwinference::wwinference(
  ww_data = ww_data_to_fit_exp,
  count_data = hosp_data_preprocessed_exp,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = fit_options,
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 2
)
```

## Fitting rand. corr. matrix data
Finally, we fit the rand. corr. matrix data generation model to all three of the
inference models.  Again, the inference models only differ by their assumed
site to site correlation structures.

<div class="fold s o">
```{r warning=FALSE, message=FALSE}
# Rand. Corr. Matrix data to IID model -----------------------------------------
fit_rand_to_iid <- wwinference::wwinference(
  ww_data = ww_data_to_fit_rng_corr_mat,
  count_data = hosp_data_proc_rng_corr_mat,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = fit_options,
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 0
)
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data to Exponential model ---------------------------------
fit_rand_to_exp <- wwinference::wwinference(
  ww_data = ww_data_to_fit_rng_corr_mat,
  count_data = hosp_data_proc_rng_corr_mat,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = fit_options,
  compiled_model = model,
  dist_matrix = as.matrix(exp_corr_param$dist_matrix),
  corr_structure_switch = 1
)
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data to Unstructured model --------------------------------
fit_rand_to_unstruct <- wwinference::wwinference(
  ww_data = ww_data_to_fit_rng_corr_mat,
  count_data = hosp_data_proc_rng_corr_mat,
  forecast_date = forecast_date,
  calibration_time = calibration_time,
  forecast_horizon = forecast_horizon,
  model_spec = get_model_spec(
    generation_interval = generation_interval,
    inf_to_count_delay = inf_to_hosp,
    infection_feedback_pmf = infection_feedback_pmf,
    params = params
  ),
  fit_opts = fit_options,
  compiled_model = model,
  dist_matrix = NULL,
  corr_structure_switch = 2
)
```

## Preparing sampled draws
Here we prepare results for visualization.  This step is not part of visualizing
spatial wwinference results, a simpler way is in the `wwinference` vignette
that uses the package's build in functionality for plotting.  Our goal here is
to compare the three data generation models agains the three inference models.

We start with just sampling a portion of the draws that came from the results.
We also combine all the results into one dataset with columns indicating what
data generation model and inference model was used.

<div class="fold s">
```{r}
set.seed(2024)
draws_to_keep <- sample(1:max(get_draws(
  fit_iid_to_iid,
  what = "predicted_counts"
)$predicted_counts$draw), 100)
# IID data ---------------------------------------------------------------------
iid_pred_draws_df <- rbind(
  get_draws(fit_iid_to_iid,
    what = "predicted_counts"
  )$predicted_counts %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_iid_to_exp,
    what = "predicted_counts"
  )$predicted_counts %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_iid_to_unstruct,
    what = "predicted_counts"
  )$predicted_counts %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "IID"
  )
# ------------------------------------------------------------------------------
# Exponential data -------------------------------------------------------------
exp_pred_draws_df <- rbind(
  get_draws(fit_exp_to_iid,
    what = "predicted_counts"
  )$predicted_counts %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_exp_to_exp,
    what = "predicted_counts"
  )$predicted_counts %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_exp_to_unstruct,
    what = "predicted_counts"
  )$predicted_counts %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "Exponential"
  )
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data ------------------------------------------------------
rand_pred_draws_df <- rbind(
  get_draws(fit_rand_to_iid,
    what = "predicted_counts"
  )$predicted_counts %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_rand_to_exp,
    what = "predicted_counts"
  )$predicted_counts %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_rand_to_unstruct,
    what = "predicted_counts"
  )$predicted_counts %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "Rand. Corr. Matrix"
  )
# ------------------------------------------------------------------------------
all_pred_draws_df <- rbind(
  iid_pred_draws_df,
  exp_pred_draws_df,
  rand_pred_draws_df
) %>%
  mutate(
    inf_model_type = factor(
      inf_model_type,
      levels = c(
        "Exponential",
        "Unstructured",
        "IID"
      )
    ),
    gen_model_type = factor(
      gen_model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )

# Wastewater draws------------------------------
iid_ww_draws_df <- rbind(
  get_draws(fit_iid_to_iid,
    what = "predicted_ww"
  )$predicted_ww %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_iid_to_exp,
    what = "predicted_ww"
  )$predicted_ww %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_iid_to_unstruct,
    what = "predicted_ww"
  )$predicted_ww %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "IID"
  )
# ------------------------------------------------------------------------------
# Exponential data -------------------------------------------------------------
exp_ww_draws_df <- rbind(
  get_draws(fit_exp_to_iid,
    what = "predicted_ww"
  )$predicted_ww %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_exp_to_exp,
    what = "predicted_ww"
  )$predicted_ww %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_exp_to_unstruct,
    what = "predicted_ww"
  )$predicted_ww %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "Exponential"
  )
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data ------------------------------------------------------
rand_ww_draws_df <- rbind(
  get_draws(fit_rand_to_iid,
    what = "predicted_ww"
  )$predicted_ww %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_rand_to_exp,
    what = "predicted_ww"
  )$predicted_ww %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_rand_to_unstruct,
    what = "predicted_ww"
  )$predicted_ww %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "Rand. Corr. Matrix"
  )

all_ww_draws_df <- rbind(
  iid_ww_draws_df,
  exp_ww_draws_df,
  rand_ww_draws_df
) %>%
  mutate(
    inf_model_type = factor(
      inf_model_type,
      levels = c(
        "Exponential",
        "Unstructured",
        "IID"
      )
    ),
    gen_model_type = factor(
      gen_model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )

# Global R(t) draws-------------------------------------------
iid_rt_draws_df <- rbind(
  get_draws(fit_iid_to_iid,
    what = "global_rt"
  )$global_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_iid_to_exp,
    what = "global_rt"
  )$global_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_iid_to_unstruct,
    what = "global_rt"
  )$global_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "IID"
  )
# ------------------------------------------------------------------------------
# Exponential data -------------------------------------------------------------
exp_rt_draws_df <- rbind(
  get_draws(fit_exp_to_iid,
    what = "global_rt"
  )$global_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_exp_to_exp,
    what = "global_rt"
  )$global_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_exp_to_unstruct,
    what = "global_rt"
  )$global_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "Exponential"
  )
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data ------------------------------------------------------
rand_rt_draws_df <- rbind(
  get_draws(fit_rand_to_iid,
    what = "global_rt"
  )$global_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_rand_to_exp,
    what = "global_rt"
  )$global_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_rand_to_unstruct,
    what = "global_rt"
  )$global_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "Rand. Corr. Matrix"
  )

all_rt_draws_df <- rbind(
  iid_rt_draws_df,
  exp_rt_draws_df,
  rand_rt_draws_df
) %>%
  mutate(
    inf_model_type = factor(
      inf_model_type,
      levels = c(
        "Exponential",
        "Unstructured",
        "IID"
      )
    ),
    gen_model_type = factor(
      gen_model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )

# Subpop R(t) ---------------------------

iid_subpop_rt_draws_df <- rbind(
  get_draws(fit_iid_to_iid,
    what = "subpop_rt"
  )$subpop_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_iid_to_exp,
    what = "subpop_rt"
  )$subpop_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_iid_to_unstruct,
    what = "subpop_rt"
  )$subpop_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "IID"
  )
# ------------------------------------------------------------------------------
# Exponential data -------------------------------------------------------------
exp_subpop_rt_draws_df <- rbind(
  get_draws(fit_exp_to_iid,
    what = "subpop_rt"
  )$subpop_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_exp_to_exp,
    what = "subpop_rt"
  )$subpop_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_exp_to_unstruct,
    what = "subpop_rt"
  )$subpop_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "Exponential"
  )
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data ------------------------------------------------------
rand_subpop_rt_draws_df <- rbind(
  get_draws(fit_rand_to_iid,
    what = "subpop_rt"
  )$subpop_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "IID"
    ),
  get_draws(fit_rand_to_exp,
    what = "subpop_rt"
  )$subpop_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Exponential"
    ),
  get_draws(fit_rand_to_unstruct,
    what = "subpop_rt"
  )$subpop_rt %>%
    filter(draw %in% draws_to_keep) %>%
    mutate(
      inf_model_type = "Unstructured"
    )
) %>%
  mutate(
    gen_model_type = "Rand. Corr. Matrix"
  )

all_subpop_rt_draws_df <- rbind(
  iid_subpop_rt_draws_df,
  exp_subpop_rt_draws_df,
  rand_subpop_rt_draws_df
) %>%
  mutate(
    inf_model_type = factor(
      inf_model_type,
      levels = c(
        "Exponential",
        "Unstructured",
        "IID"
      )
    ),
    gen_model_type = factor(
      gen_model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
```


## Preparing sampled draws for correlation matrix
Here we prepare results for visualizing the correlation matrix posterior
distributions.  Again this is not a required step, but this is not included in
the `wwinference` vignette.

We start by looking at the raw draws of our fit object, then select the draws
from `non_norm_omega`, which is the matrix that contains non-normalized
correlations.  For more information on normalized vs non-normalized
correlations, refer to the model definitions.  We then make a dataset that has a
three columns, two of indicating the site to site correlations.  The third
containing the correlation value.  We also do this for each of the nine fits we
did above, and combine them into one dataset with columns indicating what data
generation model and inference model was used.

<div class="fold s">
```{r}
# IID data ---------------------------------------------------------------------
iid_corr_matrix_draws_df <- rbind(
  fit_iid_to_iid$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "IID"
    ) %>%
    select(
      -variable
    ),
  fit_iid_to_exp$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Exponential"
    ) %>%
    select(
      -variable
    ),
  fit_iid_to_unstruct$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Unstructured"
    ) %>%
    select(
      -variable
    )
) %>%
  mutate(
    gen_model_type = "IID"
  )
# ------------------------------------------------------------------------------
# Exponential data -------------------------------------------------------------
exp_corr_matrix_draws_df <- rbind(
  fit_exp_to_iid$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "IID"
    ) %>%
    select(
      -variable
    ),
  fit_exp_to_exp$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Exponential"
    ) %>%
    select(
      -variable
    ),
  fit_exp_to_unstruct$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Unstructured"
    ) %>%
    select(
      -variable
    )
) %>%
  mutate(
    gen_model_type = "Exponential"
  )
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix data ------------------------------------------------------
rand_corr_matrix_draws_df <- rbind(
  fit_rand_to_iid$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "IID"
    ) %>%
    select(
      -variable
    ),
  fit_rand_to_exp$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Exponential"
    ) %>%
    select(
      -variable
    ),
  fit_iid_to_unstruct$fit$result$draws(
    variables = "non_norm_omega",
    format = "draws_array"
  ) %>%
    as.table() %>%
    as.data.frame() %>%
    mutate(
      Row = sub(
        "non_norm_omega\\[(\\d+),\\d+\\]",
        "Site \\1",
        variable
      ),
      Column = sub(
        "non_norm_omega\\[\\d+,(\\d+)\\]",
        "Site \\1",
        variable
      ),
      inf_model_type = "Unstructured"
    ) %>%
    select(
      -variable
    )
) %>%
  mutate(
    gen_model_type = "Rand. Corr. Matrix"
  )
# ------------------------------------------------------------------------------
all_corr_matrix_draws_df <- rbind(
  iid_corr_matrix_draws_df,
  exp_corr_matrix_draws_df,
  rand_corr_matrix_draws_df
) %>%
  mutate(
    inf_model_type = factor(
      inf_model_type,
      levels = c(
        "IID",
        "Exponential",
        "Unstructured"
      )
    ),
    gen_model_type = factor(
      gen_model_type,
      levels = c(
        "IID",
        "Exponential",
        "Rand. Corr. Matrix"
      )
    )
  )
```

# Visualizing Fits
Here we visualize all the results. For each one, we look at the 95th quantile
of the parameters we are interested in.

## Hospital admissions and wastewater
Here we showcase the hospital admissions and wastewater results.  We facet again
by the data generation model.  The colors represent the different inference
models, where the only difference between the inference models are the assumed
correlation structure.  Solid lines are medians of the distributions, solid dots
are data points used to fit the model, open dots are for evaluation purposes.
The vertical dashed line represents the date that we told the model to begin
forecasting which ends based off the forecast horizon specified in the model
presets.  The nowcasting period will be from the period from the last solid dot
to the dashed line.  The forecast period is the period after the dashed line.
Below hospital admissions, we have the wastewater concentration posterior
predictions, with the same notations as the hospital admissions.

Exploring these results, we see that all models do relatively well to include
evaluation points, open dots, in their 95th quantiles.  Later in the vignette,
evaluation metrics will be used to quantify forecast performance.

<div class="fold s">
```{r warning=FALSE}
# Hospital admissions results --------------------------------------------------
hosp_ribbon_data <- all_pred_draws_df %>%
  group_by(
    date,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(pred_value, 0.025, na.rm = TRUE),
    median = median(pred_value),
    upper = quantile(pred_value, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
hosp_result_plot <- ggplot(
  all_pred_draws_df
) +
  geom_ribbon(
    data = hosp_ribbon_data,
    aes(x = date, ymin = lower, ymax = upper, fill = inf_model_type),
    alpha = 0.1
  ) +
  geom_line(
    data = hosp_ribbon_data,
    aes(x = date, y = median, color = inf_model_type),
    size = 1,
  ) +
  geom_point(
    data = hosp_data_eval_full %>%
      mutate(gen_model_type = model_type),
    aes(x = date, y = daily_hosp_admits_for_eval),
    shape = 21, color = "black", fill = "white"
  ) +
  geom_point(
    aes(x = date, y = observed_value)
  ) +
  geom_vline(aes(xintercept = lubridate::ymd(forecast_date)),
    linetype = "dashed"
  ) +
  xlab("") +
  ylab("Daily hospital admissions") +
  facet_wrap(~gen_model_type, scales = "free_y") +
  guides(
    fill = guide_legend(
      title = "Assumed Corr. Structure"
    ),
    color = guide_legend(
      title = "Assumed Corr. Structure"
    )
  ) +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  theme_bw()


# Wastewater results -----------------------------------------------------------
ww_ribbon_data <- all_ww_draws_df %>%
  group_by(
    date,
    site,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(pred_value, 0.025, na.rm = TRUE),
    median = median(pred_value),
    upper = quantile(pred_value, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
ww_result_plot <- ggplot(
  all_ww_draws_df
) +
  geom_ribbon(
    data = ww_ribbon_data,
    aes(x = date, ymin = lower, ymax = upper, fill = inf_model_type),
    alpha = 0.1
  ) +
  geom_line(
    data = ww_ribbon_data,
    aes(x = date, y = median, color = inf_model_type),
    size = 1,
  ) +
  geom_point(
    aes(x = date, y = observed_value)
  ) +
  geom_vline(aes(xintercept = lubridate::ymd(forecast_date)),
    linetype = "dashed"
  ) +
  xlab("") +
  ylab("Genome copies/mL on Log Scale") +
  facet_grid(site ~ gen_model_type, scales = "free_y") +
  guides(
    fill = guide_legend(
      title = "Assumed Corr. Structure"
    ),
    color = guide_legend(
      title = "Assumed Corr. Structure"
    )
  ) +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  theme_bw()
# ------------------------------------------------------------------------------

(hosp_result_plot / ww_result_plot) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```

## $\mathcal{R}(t)$ curves, global and site
Here we showcase the global and site level $\mathcal{R}(t)$'s.  Notation is the
same as hospital admissions and wastewater results, except here the true
simulated global and site $\mathcal{R}(t)$ curves are plotted for visual
evaluation.  The true simulated $\mathcal{R}(t)$ curves are latent quantities
that must be inferred by the model.

We do very well to capture the actual $\mathcal{R}(t)$ curves.  There is some
concern with how high the inferred $\mathcal{R}(t)$ reaches toward the
nowcasting and forecasting periods.  We expect to see higher uncertainty in the
nowcasting and forecasting periods because the $\mathcal{R}(t)$ is only
partially or not at all informed by recent data.

<div class="fold s">
```{r}
# Global Rt results ------------------------------------------------------------


global_rt_ribbon_data <- all_rt_draws_df %>%
  group_by(
    date,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(pred_value, 0.025, na.rm = TRUE),
    median = median(pred_value),
    upper = quantile(pred_value, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
global_rt_result_plot <- ggplot(
  all_pred_draws_df
) +
  geom_ribbon(
    data = global_rt_ribbon_data,
    aes(x = date, ymin = lower, ymax = upper, fill = inf_model_type),
    alpha = 0.2
  ) +
  geom_line(
    data = global_rt_ribbon_data,
    aes(x = date, y = median, color = inf_model_type),
    size = 1.25,
  ) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    alpha = .7,
    size = 1,
    linetype = "dashed"
  ) +
  geom_line(
    data = rt_global_data_full %>%
      mutate(gen_model_type = model_type),
    aes(x = date, y = global_rt),
    size = 1.25
  ) +
  geom_vline(aes(xintercept = lubridate::ymd(forecast_date)),
    linetype = "dashed"
  ) +
  xlab("") +
  ylab("Global Rt Results") +
  facet_wrap(~gen_model_type, scales = "free_y") +
  guides(
    fill = guide_legend(
      title = "Assumed Corr. Structure"
    ),
    color = guide_legend(
      title = "Assumed Corr. Structure"
    )
  ) +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_y_continuous(trans = "log10") +
  theme_bw()
# ------------------------------------------------------------------------------
# Site Rt results --------------------------------------------------------------
site_rt_ribbon_data <- all_subpop_rt_draws_df %>%
  group_by(
    date,
    subpop_name,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(pred_value, 0.025, na.rm = TRUE),
    median = median(pred_value),
    upper = quantile(pred_value, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
site_rt_result_plot <- ggplot() +
  geom_ribbon(
    data = site_rt_ribbon_data,
    aes(x = date, ymin = lower, ymax = upper, fill = inf_model_type),
    alpha = 0.2
  ) +
  geom_line(
    data = site_rt_ribbon_data,
    aes(x = date, y = median, color = inf_model_type),
    size = 1.25,
  ) +
  geom_hline(
    yintercept = 1,
    color = "blue",
    alpha = .7,
    size = 1,
    linetype = "dashed"
  ) +
  geom_line(
    data = site_rt_data_full %>%
      mutate(gen_model_type = model_type),
    aes(x = date, y = value),
    size = 1.25
  ) +
  geom_vline(
    xintercept = lubridate::ymd(forecast_date),
    linetype = "dashed"
  ) +
  xlab("") +
  ylab("Site Rt") +
  facet_grid(subpop_name ~ gen_model_type, scales = "free_y") +
  guides(
    fill = guide_legend(
      title = "Assumed Corr. Structure"
    ),
    color = guide_legend(
      title = "Assumed Corr. Structure"
    )
  ) +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  scale_y_continuous(trans = "log10") +
  theme_bw()
# ------------------------------------------------------------------------------

global_rt_result_plot / site_rt_result_plot +
  plot_layout(
    guides = "collect",
    heights = c(1, n_sites)
  ) &
  theme(legend.position = "bottom")
```

## Correlation matrix
The last visual we will see of the results is the posteriors of the elements in
the correlation matrix.  Here we violate our previous plot structures and have
the data generation models on separate plots as opposed to faceting them.  We
have inference model indicated by the color.  Red dashed lines are the actual
site to site correlations.  Solid dots are the medians, and the solid line with
the line stops is the 95th quantile.

A couple of things to note here is that the exponential inference model will not
be able to sample a negative value.  But regardless, each inference model does
well enough, with an unstructured correlation assumption inference model
performing visually better then the exponential correlation assumption.

<div class="fold s">
```{r message=FALSE, fig.height=5, fig.width=15}
# IID Correlation Matrix -------------------------------------------------------
iid_corr_matrix_result_plot <- ggplot(all_corr_matrix_draws_df %>%
  group_by(
    Row,
    Column,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(Freq, 0.025, na.rm = TRUE),
    median = median(Freq),
    upper = quantile(Freq, 0.975, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(
    gen_model_type == "IID",
    inf_model_type != "IID"
  )) +
  geom_point(
    aes(
      x = median, y = inf_model_type,
      colour = inf_model_type
    ),
    size = 2.5
  ) +
  geom_errorbarh(
    aes(
      xmin = lower, xmax = upper,
      y = inf_model_type,
      colour = inf_model_type
    ),
    height = 0.2,
    size = 1
  ) +
  geom_vline(
    data = corr_matrix_df %>%
      filter(model_type == "IID") %>%
      mutate(
        Row = Var1,
        Column = Var2
      ),
    aes(xintercept = value),
    color = "red",
    linetype = "dashed",
    size = 1
  ) +
  facet_grid(Row ~ Column, switch = "y") +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured"),
    values = c("darkviolet", "deeppink3")
  ) +
  ylab("") +
  xlab("Correlation Drawed") +
  ggtitle("Data Generation Model : IID") +
  labs(
    color = "Assumed Corr. Structure",
    fill = "Assumed Corr. Structure"
  ) +
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
# ------------------------------------------------------------------------------
# Exponential Correlation Matrix -----------------------------------------------
exp_corr_matrix_result_plot <- ggplot(all_corr_matrix_draws_df %>%
  group_by(
    Row,
    Column,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(Freq, 0.025, na.rm = TRUE),
    median = median(Freq),
    upper = quantile(Freq, 0.975, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(
    gen_model_type == "Exponential",
    inf_model_type != "IID"
  )) +
  geom_point(
    aes(
      x = median, y = inf_model_type,
      colour = inf_model_type
    ),
    size = 2.5
  ) +
  geom_errorbarh(
    aes(
      xmin = lower, xmax = upper,
      y = inf_model_type,
      colour = inf_model_type
    ),
    height = 0.2,
    size = 1
  ) +
  geom_vline(
    data = corr_matrix_df %>%
      filter(model_type == "Exponential") %>%
      mutate(
        Row = Var1,
        Column = Var2
      ),
    aes(xintercept = value),
    color = "red",
    linetype = "dashed",
    size = 1
  ) +
  facet_grid(Row ~ Column, switch = "y") +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured"),
    values = c("darkviolet", "deeppink3")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured"),
    values = c("darkviolet", "deeppink3")
  ) +
  ylab("") +
  xlab("Correlation Drawed") +
  ggtitle("Data Generation Model : Exponential") +
  labs(
    color = "Assumed Corr. Structure",
    fill = "Assumed Corr. Structure"
  ) +
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
# ------------------------------------------------------------------------------
# Rand. Corr. Matrix Correlation Matrix ----------------------------------------
rand_corr_matrix_result_plot <- ggplot(all_corr_matrix_draws_df %>%
  group_by(
    Row,
    Column,
    inf_model_type,
    gen_model_type
  ) %>%
  summarise(
    lower = quantile(Freq, 0.025, na.rm = TRUE),
    median = median(Freq),
    upper = quantile(Freq, 0.975, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(
    gen_model_type == "Rand. Corr. Matrix",
    inf_model_type != "IID"
  )) +
  geom_point(
    aes(
      x = median, y = inf_model_type,
      colour = inf_model_type
    ),
    size = 2.5
  ) +
  geom_errorbarh(
    aes(
      xmin = lower, xmax = upper,
      y = inf_model_type,
      colour = inf_model_type
    ),
    height = 0.2,
    size = 1
  ) +
  geom_vline(
    data = corr_matrix_df %>%
      filter(model_type == "Rand. Corr. Matrix") %>%
      mutate(
        Row = Var1,
        Column = Var2
      ),
    aes(xintercept = value),
    color = "red",
    linetype = "dashed",
    size = 1
  ) +
  facet_grid(Row ~ Column, switch = "y") +
  scale_fill_manual(
    breaks = c("Exponential", "Unstructured"),
    values = c("darkviolet", "deeppink3")
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured"),
    values = c("darkviolet", "deeppink3")
  ) +
  ylab("") +
  xlab("Correlation Drawed") +
  ggtitle("Data Generation Model : Rand. Corr. Matrix") +
  labs(
    color = "Assumed Corr. Structure",
    fill = "Assumed Corr. Structure"
  ) +
  theme_bw() +
  theme(
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
# ------------------------------------------------------------------------------

iid_corr_matrix_result_plot + exp_corr_matrix_result_plot +
  rand_corr_matrix_result_plot +
  plot_layout(
    guides = "collect"
  ) &
  theme(legend.position = "bottom")
```


# Quantitative Forecast Evaluation Results
For this section we explore how well our forecasts performed quantitatively.
The metrics that we will be using are effective sample size per second
(ess/sec), continuous ranked probability score (CRPS), David-Sebastiani score
(DSS), absolute error (AE), squared error (SE), and bias.  All these, apart from
ess/sec, will get attained using the
[scoringutils](https://epiforecasts.io/scoringutils/index.html) package.

We start by getting the ess/sec by looking at the fit object's mean bulk
effective sample size and total computation time.  Here, larger ess/sec is
better. This will be combined with the evaluation metrics from
[scoringutils](https://epiforecasts.io/scoringutils/index.html)

<div class="fold s">
```{r warning=FALSE}
# effective sample size per second ---------------------------------------------
fit_names <- list(
  fit_iid_to_iid, fit_iid_to_exp, fit_iid_to_unstruct,
  fit_exp_to_iid, fit_exp_to_exp, fit_exp_to_unstruct,
  fit_rand_to_iid, fit_rand_to_exp, fit_rand_to_unstruct
)
gen_names <- c(
  "IID", "IID", "IID",
  "Exponential", "Exponential", "Exponential",
  "Rand. Corr. Matrix", "Rand. Corr. Matrix", "Rand. Corr. Matrix"
)
inf_names <- c(
  "IID", "Exponential", "Unstructured",
  "IID", "Exponential", "Unstructured",
  "IID", "Exponential", "Unstructured"
)
ess_per_sec_df <- data.frame(
  model = rep(0, 9),
  gen_model_type = rep(0, 9),
  ess_per_sec = rep(0, 9)
)
for (i in 1:9) {
  curr_fit <- fit_names[[i]]
  ess_per_sec_df$gen_model_type[i] <- gen_names[i]
  ess_per_sec_df$model[i] <- inf_names[i]
  ess_per_sec_df$ess_per_sec[i] <- mean(
    curr_fit$fit$result$summary()$ess_bulk,
    na.rm = TRUE
  ) / curr_fit$fit$result$time()$total
}
# ------------------------------------------------------------------------------
```

## Hospital admissions evaluations
Here we prepare the evaluation metric plots.  The general form will be a plot
that is by date, and another tile plot where the darker the color, the higher
the value.  For most of the metrics, smaller is better, but for ess/sec, higher
is better.

### Hospital admissions at forecast period evaluation scores
Again, here we prepare evaluation metric plots for the forecast period, where we
make a plot that looks at metrics by date and then across the entire forecast
period.

```{r}
hosp_obj_for_eval_forcast <- all_pred_draws_df %>%
  filter(
    date > forecast_date
  ) %>%
  inner_join(
    hosp_data_eval_full %>%
      filter(
        date > forecast_date
      ) %>%
      mutate(
        gen_model_type = model_type,
        true_value = daily_hosp_admits_for_eval
      ) %>%
      select(
        date,
        true_value,
        gen_model_type
      ),
    by = c("date", "gen_model_type")
  ) %>%
  mutate(
    predicted = pred_value,
    observed = true_value,
    sample_id = draw,
    model = inf_model_type
  ) %>%
  select(
    predicted,
    observed,
    sample_id,
    date,
    model,
    gen_model_type
  )

hosp_scores_forecast <- hosp_obj_for_eval_forcast %>%
  as_forecast_sample(
    forecast_unit = c(
      "date", "model", "gen_model_type"
    )
  ) |>
  score() %>%
  inner_join(
    ess_per_sec_df,
    by = c("model", "gen_model_type")
  )

hosp_by_date_eval_forecast_plot <- ggplot( # nolint
  hosp_scores_forecast %>%
    pivot_longer(
      cols = -c("date", "model", "gen_model_type"),
      names_to = "Evaluation Score",
      values_to = "Score"
    ) %>%
    mutate(
      `Evaluation Score` = case_when(
        `Evaluation Score` == "crps" ~ "CRPS",
        `Evaluation Score` == "dss" ~ "DSS",
        `Evaluation Score` == "ae_median" ~ "AE",
        `Evaluation Score` == "se_mean" ~ "SE",
        `Evaluation Score` == "bias" ~ "Bias",
        `Evaluation Score` == "ess_per_sec" ~ "ess/sec",
        .default = `Evaluation Score`
      )
    ) %>%
    mutate(
      model = factor(
        model,
        levels = c(
          "IID",
          "Exponential",
          "Unstructured"
        )
      ),
      gen_model_type = factor(
        gen_model_type,
        levels = c(
          "IID",
          "Exponential",
          "Rand. Corr. Matrix"
        )
      )
    )
) +
  geom_point(
    aes(x = date, y = Score, colour = model)
  ) +
  geom_line(
    aes(x = date, y = Score, colour = model)
  ) +
  facet_grid2(`Evaluation Score` ~ gen_model_type,
    scales = "free",
    independent = "y"
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  labs(color = "Assumed Corr. Structure") +
  ggtitle("Hospital Admission Forecast Period Evaluation Metric By Date") +
  ylab("Score") +
  xlab("Date") +
  theme_bw()
# Remove the new scores added to new scoringutils, stick with originals
hosp_scores_forecast <- hosp_scores_forecast |>
  dplyr::select(-underprediction, overprediction, dispersion)

attr(hosp_scores_forecast, "metrics") <- c(
  "bias", "dss", "crps", "log_score",
  "mad", "ae_median", "se_mean"
)


hosp_eval_forecast_plot <- ggplot(
  hosp_scores_forecast %>%
    summarize_scores(by = c("model", "gen_model_type")) %>%
    inner_join(
      ess_per_sec_df,
      by = c("model", "gen_model_type")
    ) %>%
    pivot_longer(
      cols = -c("model", "gen_model_type"),
      names_to = "Evaluation Score",
      values_to = "Score"
    ) %>%
    mutate(
      `Evaluation Score` = case_when(
        `Evaluation Score` == "crps" ~ "CRPS",
        `Evaluation Score` == "dss" ~ "DSS",
        `Evaluation Score` == "ae_median" ~ "AE",
        `Evaluation Score` == "se_mean" ~ "SE",
        `Evaluation Score` == "bias" ~ "Bias",
        `Evaluation Score` == "ess_per_sec" ~ "ess/sec",
        .default = `Evaluation Score`
      )
    ) %>%
    group_by(gen_model_type, `Evaluation Score`) %>%
    mutate(
      scaled_score = (Score - min(Score)) / (max(Score) - min(Score))
    ) %>%
    ungroup() %>%
    mutate(
      model = factor(
        model,
        levels = c(
          "IID",
          "Exponential",
          "Unstructured"
        )
      ),
      gen_model_type = factor(
        gen_model_type,
        levels = c(
          "IID",
          "Exponential",
          "Rand. Corr. Matrix"
        )
      )
    )
) +
  geom_tile(
    aes(x = model, y = `Evaluation Score`, fill = scaled_score),
    color = "black"
  ) +
  geom_text(
    aes(
      x = model,
      y = `Evaluation Score`,
      label = sprintf("%.2f", Score)
    ),
    color = "black",
    size = 3.5
  ) +
  facet_wrap(~gen_model_type) +
  scale_fill_gradient(
    low = "white",
    high = "dodgerblue"
  ) +
  guides(fill = "none") +
  labs(fill = "Score Relative to Metric") +
  ggtitle("Hospital Admission Forecast Period Evaluation Metric") +
  ylab("Evalutation Metric") +
  xlab("Assumed Correlation Structure") +
  theme_bw()
```

Here we show the raw scores for the forecast period, where model is the
inference model and gen_model_type is the data generation model.

```{r}
# Raw Scores :
hosp_scores_forecast %>%
  summarize_scores(by = c("model", "gen_model_type")) %>%
  inner_join(
    ess_per_sec_df,
    by = c("model", "gen_model_type")
  )
```

### Hospital admissions at nowcasting period evaluation scores
Here we prepare the evaluation metric plots for the nowcasting period.  We still
make two plots one for metrics by date, and another across all dates.

```{r}
hosp_obj_for_eval_nowcast <- all_pred_draws_df %>%
  filter(
    date > max(hosp_data$date),
    date <= forecast_date
  ) %>%
  inner_join(
    hosp_data_eval_full %>%
      filter(
        date > max(hosp_data$date),
        date <= forecast_date
      ) %>%
      mutate(
        gen_model_type = model_type,
        true_value = daily_hosp_admits_for_eval
      ) %>%
      select(
        date,
        true_value,
        gen_model_type
      ),
    by = c("date", "gen_model_type")
  ) %>%
  mutate(
    predicted = pred_value,
    observed = true_value,
    sample_id = draw,
    model = inf_model_type
  ) %>%
  select(
    predicted,
    observed,
    sample_id,
    date,
    model,
    gen_model_type
  )

hosp_scores_nowcast <- hosp_obj_for_eval_nowcast %>%
  as_forecast_sample(
    forecast_unit = c(
      "date", "model", "gen_model_type"
    )
  ) %>%
  score() %>%
  inner_join(
    ess_per_sec_df,
    by = c("model", "gen_model_type")
  )

hosp_by_date_eval_nowcast_plot <- ggplot(
  hosp_scores_nowcast %>%
    pivot_longer(
      cols = -c("date", "model", "gen_model_type"),
      names_to = "Evaluation Score",
      values_to = "Score"
    ) %>%
    mutate(
      `Evaluation Score` = case_when(
        `Evaluation Score` == "crps" ~ "CRPS",
        `Evaluation Score` == "dss" ~ "DSS",
        `Evaluation Score` == "ae_median" ~ "AE",
        `Evaluation Score` == "se_mean" ~ "SE",
        `Evaluation Score` == "bias" ~ "Bias",
        `Evaluation Score` == "ess_per_sec" ~ "ess/sec",
        .default = `Evaluation Score`
      )
    ) %>%
    mutate(
      model = factor(
        model,
        levels = c(
          "IID",
          "Exponential",
          "Unstructured"
        )
      ),
      gen_model_type = factor(
        gen_model_type,
        levels = c(
          "IID",
          "Exponential",
          "Rand. Corr. Matrix"
        )
      )
    )
) +
  geom_point(
    aes(x = date, y = Score, colour = model)
  ) +
  geom_line(
    aes(x = date, y = Score, colour = model)
  ) +
  facet_grid2(`Evaluation Score` ~ gen_model_type,
    scales = "free",
    independent = "y"
  ) +
  scale_colour_manual(
    breaks = c("Exponential", "Unstructured", "IID"),
    values = c("darkviolet", "deeppink3", "darksalmon")
  ) +
  labs(color = "Assumed Corr. Structure") +
  ggtitle("Hospital Admission Nowcast Period Evaluation Metric By Date") +
  ylab("Score") +
  xlab("Date") +
  theme_bw()

hosp_scores_nowcast <- hosp_scores_nowcast %>%
  dplyr::select(-underprediction, -overprediction, -dispersion)

attr(hosp_scores_nowcast, "metrics") <- c(
  "bias", "dss", "crps", "log_score",
  "mad", "ae_median", "se_mean"
)
hosp_eval_nowcast_plot <- ggplot(
  hosp_scores_nowcast %>%
    summarize_scores(by = c("model", "gen_model_type")) %>%
    inner_join(
      ess_per_sec_df,
      by = c("model", "gen_model_type")
    ) %>%
    pivot_longer(
      cols = -c("model", "gen_model_type"),
      names_to = "Evaluation Score",
      values_to = "Score"
    ) %>%
    mutate(
      `Evaluation Score` = case_when(
        `Evaluation Score` == "crps" ~ "CRPS",
        `Evaluation Score` == "dss" ~ "DSS",
        `Evaluation Score` == "ae_median" ~ "AE",
        `Evaluation Score` == "se_mean" ~ "SE",
        `Evaluation Score` == "bias" ~ "Bias",
        `Evaluation Score` == "ess_per_sec" ~ "ess/sec",
        .default = `Evaluation Score`
      )
    ) %>%
    group_by(gen_model_type, `Evaluation Score`) %>%
    mutate(
      scaled_score = (Score - min(Score)) / (max(Score) - min(Score))
    ) %>%
    ungroup() %>%
    mutate(
      model = factor(
        model,
        levels = c(
          "IID",
          "Exponential",
          "Unstructured"
        )
      ),
      gen_model_type = factor(
        gen_model_type,
        levels = c(
          "IID",
          "Exponential",
          "Rand. Corr. Matrix"
        )
      )
    )
) +
  geom_tile(
    aes(x = model, y = `Evaluation Score`, fill = scaled_score),
    color = "black"
  ) +
  geom_text(
    aes(
      x = model,
      y = `Evaluation Score`,
      label = sprintf("%.2f", Score)
    ),
    color = "black",
    size = 3.5
  ) +
  facet_wrap(~gen_model_type) +
  scale_fill_gradient(
    low = "white",
    high = "dodgerblue"
  ) +
  guides(fill = "none") +
  labs(fill = "Score Relative to Metric") +
  ggtitle("Hospital Admission Nowcast Period Evaluation Metric") +
  ylab("Evalutation Metric") +
  xlab("Assumed Correlation Structure") +
  theme_bw()
```

Here we show the raw scores for the nowcasting period, where model is the
inference model and gen_model_type is the data generation model.

```{r}
# Raw Scores :
hosp_scores_nowcast %>%
  summarize_scores(by = c("model", "gen_model_type")) %>%
  inner_join(
    ess_per_sec_df,
    by = c("model", "gen_model_type")
  )
```

### Hospital admissions evaluation scores plot
Here we showcase the evaluation metric scores.

```{r}
(hosp_eval_nowcast_plot + hosp_eval_forecast_plot) /
  (hosp_by_date_eval_nowcast_plot + hosp_by_date_eval_forecast_plot) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```


## Wastewater evaluations
